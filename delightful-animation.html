<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Delightful — Animation System</title>
  <meta name="description" content="JS-powered animations: spring physics, particles, generative art, and interactive playgrounds. Part of the Delightful Design System." />
  <meta property="og:title" content="Delightful — Animation System" />
  <meta property="og:description" content="Spring physics, particles, FLIP, gestures, generative art — all vanilla JS, all token-driven." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet" />

  <style>
    /* Cascade layer order — earlier layers have lower priority */
    @layer reset, primitives, semantic, component, utilities;

    /* ==========================================================================
       TIER 1 — PRIMITIVES
       Raw oklch values. Named by scale, no semantic meaning.
       ========================================================================== */
    @layer primitives {
    :root {
      --primitive-neutral-0: oklch(1.00 0.000 0);
      --primitive-neutral-25: oklch(0.988 0.006 70);
      --primitive-neutral-50: oklch(0.980 0.008 70);
      --primitive-neutral-100: oklch(0.960 0.010 70);
      --primitive-neutral-150: oklch(0.940 0.012 70);
      --primitive-neutral-200: oklch(0.920 0.012 70);
      --primitive-neutral-300: oklch(0.860 0.014 70);
      --primitive-neutral-400: oklch(0.750 0.014 70);
      --primitive-neutral-500: oklch(0.600 0.012 70);
      --primitive-neutral-600: oklch(0.480 0.010 70);
      --primitive-neutral-700: oklch(0.350 0.010 70);
      --primitive-neutral-800: oklch(0.250 0.012 60);
      --primitive-neutral-900: oklch(0.180 0.012 60);
      --primitive-neutral-950: oklch(0.140 0.012 60);

      --primitive-pink-100: oklch(0.920 0.060 350);
      --primitive-pink-200: oklch(0.840 0.140 350);
      --primitive-pink-300: oklch(0.720 0.220 350);
      --primitive-pink-400: oklch(0.640 0.270 350);
      --primitive-pink-500: oklch(0.560 0.280 350);

      --primitive-red-100: oklch(0.930 0.050 20);
      --primitive-red-200: oklch(0.850 0.110 20);
      --primitive-red-300: oklch(0.720 0.180 20);
      --primitive-red-400: oklch(0.620 0.220 20);
      --primitive-red-500: oklch(0.540 0.230 20);

      --primitive-gold-100: oklch(0.960 0.050 85);
      --primitive-gold-200: oklch(0.920 0.110 85);
      --primitive-gold-300: oklch(0.870 0.160 85);
      --primitive-gold-400: oklch(0.840 0.175 85);
      --primitive-gold-500: oklch(0.820 0.165 84);

      /* Cyan-blue (tertiary brand — hue 210) */
      --primitive-cyan-100: oklch(0.930 0.038 210);
      --primitive-cyan-200: oklch(0.850 0.085 210);
      --primitive-cyan-300: oklch(0.740 0.125 210);
      --primitive-cyan-400: oklch(0.650 0.148 210);
      --primitive-cyan-500: oklch(0.570 0.155 210);

      /* Green (success/safe semantic — hue 148) */
      --primitive-green-100: oklch(0.930 0.042 148);
      --primitive-green-200: oklch(0.840 0.095 148);
      --primitive-green-300: oklch(0.730 0.145 148);
      --primitive-green-400: oklch(0.630 0.170 148);
      --primitive-green-500: oklch(0.540 0.165 148);

      /* Purple/Violet (hue 300) */
      --primitive-purple-100: oklch(0.940 0.040 300);
      --primitive-purple-200: oklch(0.860 0.080 300);
      --primitive-purple-300: oklch(0.720 0.160 300);
      --primitive-purple-400: oklch(0.640 0.220 300);
      --primitive-purple-500: oklch(0.560 0.260 300);
    }
    } /* end @layer primitives */

    /* ==========================================================================
       TIER 2 — SEMANTIC TOKENS (Light) - V3 NEO-BRUTALIST
       ========================================================================== */
    @layer semantic {
    :root,
    [data-theme="light"] {
      --bg-page: oklch(0.982 0.008 70);
      /* Warm cream from code-editor palette */
      --bg-surface: oklch(0.995 0.004 70);
      --bg-elevated: oklch(1.00 0.00 0);
      --bg-subtle: oklch(0.965 0.012 70);
      --bg-muted: oklch(0.948 0.014 70);

      --text-primary: oklch(0.200 0.015 60);
      --text-secondary: oklch(0.420 0.015 60);
      --text-muted: oklch(0.560 0.012 60);
      --text-on-accent: oklch(1.00 0.000 0);
      --text-on-gold: oklch(0.220 0.020 70);

      --border-default: var(--text-primary);
      --border-strong: var(--text-primary);
      --border-subtle: oklch(0.820 0.015 70);

      /* Vibrant Accents — Warm Palette */
      --accent-primary: oklch(0.640 0.270 350);
      /* Hot pink / fuchsia */
      --accent-primary-hover: oklch(0.580 0.280 350);
      --accent-primary-subtle: oklch(0.955 0.040 350);
      --accent-primary-text: oklch(0.560 0.270 350);

      --accent-danger: oklch(0.620 0.220 20);
      /* Warm red for danger */
      --accent-danger-hover: oklch(0.570 0.230 20);
      --accent-danger-subtle: oklch(0.950 0.040 20);
      --accent-danger-text: oklch(0.570 0.220 20);

      --accent-gold: oklch(0.840 0.175 85);
      /* Warm gold */
      --accent-gold-hover: oklch(0.820 0.165 84);
      --accent-gold-subtle: oklch(0.965 0.060 85);
      --accent-gold-text: oklch(0.560 0.170 85);

      --accent-cyan: oklch(0.650 0.148 210);
      /* Cyan-blue (tertiary brand) */
      --accent-cyan-hover: oklch(0.600 0.150 210);
      --accent-cyan-subtle: oklch(0.945 0.030 210);
      --accent-cyan-text: oklch(0.560 0.148 210);

      --accent-green: oklch(0.630 0.170 148);
      /* Green (success/safe) */
      --accent-green-hover: oklch(0.580 0.165 148);
      --accent-green-subtle: oklch(0.945 0.035 148);
      --accent-green-text: oklch(0.520 0.170 148);

      --accent-purple: oklch(0.640 0.220 300);
      /* Purple/Violet */
      --accent-purple-hover: oklch(0.580 0.230 300);
      --accent-purple-subtle: oklch(0.950 0.035 300);
      --accent-purple-text: oklch(0.560 0.230 300);

      --status-info: var(--accent-primary);
      --status-error: var(--accent-danger);
      --status-warning: var(--accent-gold);
      --status-success: var(--accent-green);

      --focus-ring: var(--accent-primary);
      --overlay-bg: oklch(0.200 0.015 60 / 0.30);

      /* Neo-Brutalist Solid Shadows */
      --shadow-sm: 2px 2px 0 var(--text-primary);
      --shadow-md: 4px 4px 0 var(--text-primary);
      --shadow-lg: 8px 8px 0 var(--text-primary);
      --shadow-pink: 4px 4px 0 var(--accent-primary);
      --shadow-danger: 4px 4px 0 var(--accent-danger);
      --shadow-gold: 4px 4px 0 var(--accent-gold);
      --shadow-cyan: 4px 4px 0 var(--accent-cyan);
      --shadow-green: 4px 4px 0 var(--accent-green);
      --shadow-purple: 4px 4px 0 var(--accent-purple);
    }

    /* ==========================================================================
       TIER 2 — SEMANTIC TOKENS (Dark)
       ========================================================================== */
    [data-theme="dark"] {
      /* Warm dark backgrounds — hue 65 for amber-tinted darkness */
      --bg-page: oklch(0.140 0.014 65);
      --bg-surface: oklch(0.165 0.015 65);
      --bg-elevated: oklch(0.190 0.015 65);
      --bg-subtle: oklch(0.210 0.015 65);
      --bg-muted: oklch(0.180 0.013 65);

      --text-primary: oklch(0.935 0.008 70);
      --text-secondary: oklch(0.690 0.012 70);
      --text-muted: oklch(0.540 0.010 70);
      --text-on-accent: oklch(1.00 0.000 0);
      --text-on-gold: oklch(0.140 0.014 65);

      --border-default: oklch(0.550 0.010 65);
      /* Muted for structure — use --border-strong for emphasis */
      --border-strong: var(--text-primary);
      --border-subtle: oklch(0.330 0.015 65);

      --accent-primary: oklch(0.700 0.230 350);
      --accent-primary-hover: oklch(0.740 0.220 350);
      --accent-primary-subtle: oklch(0.250 0.065 350);
      --accent-primary-text: oklch(0.750 0.210 350);

      --accent-danger: oklch(0.660 0.200 20);
      --accent-danger-hover: oklch(0.700 0.190 20);
      --accent-danger-subtle: oklch(0.250 0.055 20);
      --accent-danger-text: oklch(0.720 0.180 20);

      --accent-gold: oklch(0.840 0.170 85);
      --accent-gold-hover: oklch(0.870 0.155 84);
      --accent-gold-subtle: oklch(0.260 0.065 85);
      --accent-gold-text: oklch(0.870 0.155 85);

      --accent-cyan: oklch(0.720 0.140 210);
      --accent-cyan-hover: oklch(0.760 0.130 210);
      --accent-cyan-subtle: oklch(0.250 0.045 210);
      --accent-cyan-text: oklch(0.780 0.130 210);

      --accent-green: oklch(0.680 0.155 148);
      --accent-green-hover: oklch(0.720 0.145 148);
      --accent-green-subtle: oklch(0.250 0.048 148);
      --accent-green-text: oklch(0.740 0.145 148);

      --accent-purple: oklch(0.700 0.200 300);
      --accent-purple-hover: oklch(0.740 0.190 300);
      --accent-purple-subtle: oklch(0.250 0.055 300);
      --accent-purple-text: oklch(0.760 0.180 300);

      --status-info: var(--accent-primary);
      --status-error: var(--accent-danger);
      --status-warning: var(--accent-gold);
      --status-success: var(--accent-green);

      --focus-ring: oklch(0.700 0.230 350);
      --overlay-bg: oklch(0 0 0 / 0.60);

      /* Neo-Brutalist Solid Shadows — Warm Inverted (cream on dark = visible 3D) */
      --shadow-sm: 2px 2px 0 oklch(0.92 0.010 65);
      --shadow-md: 4px 4px 0 oklch(0.92 0.010 65);
      --shadow-lg: 8px 8px 0 oklch(0.92 0.010 65);
      --shadow-pink: 4px 4px 0 var(--accent-primary);
      --shadow-danger: 4px 4px 0 var(--accent-danger);
      --shadow-gold: 4px 4px 0 var(--accent-gold);
      --shadow-cyan: 4px 4px 0 var(--accent-cyan);
      --shadow-green: 4px 4px 0 var(--accent-green);
      --shadow-purple: 4px 4px 0 var(--accent-purple);
    }
    } /* end @layer semantic */

    /* ==========================================================================
       TIER 3 — COMPONENT TOKENS + TYPOGRAPHY + SPACING + MOTION
       ========================================================================== */
    @layer component {
    :root {
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', ui-monospace, 'Cascadia Code', monospace;

      --step--2: clamp(0.694rem, 0.650rem + 0.22vi, 0.8rem);
      --step--1: clamp(0.833rem, 0.775rem + 0.29vi, 1rem);
      --step-0: clamp(1rem, 0.913rem + 0.43vi, 1.25rem);
      --step-1: clamp(1.2rem, 1.074rem + 0.63vi, 1.5625rem);
      --step-2: clamp(1.44rem, 1.261rem + 0.89vi, 1.953rem);
      --step-3: clamp(1.728rem, 1.480rem + 1.24vi, 2.441rem);
      --step-4: clamp(2.074rem, 1.734rem + 1.70vi, 3.052rem);
      --step-5: clamp(2.488rem, 2.028rem + 2.30vi, 3.815rem);

      --tracking-tight: -0.02em;
      --tracking-tighter: -0.03em;
      --tracking-tightest: -0.04em;

      --leading-none: 1.0;
      --leading-tight: 1.15;
      --leading-snug: 1.3;
      --leading-normal: 1.55;
      --leading-relaxed: 1.65;

      /* UI Text Scale (fixed, non-fluid — for controls) */
      --ui-text-2xs: 0.6875rem;   /* 11px — badges, table headers */
      --ui-text-xs:  0.75rem;     /* 12px — captions, hints, form errors */
      --ui-text-sm:  0.8125rem;   /* 13px — sidebar, breadcrumbs, small buttons */
      --ui-text-md:  0.875rem;    /* 14px — inputs, selects, tabs */
      --ui-text-lg:  0.9375rem;   /* 15px — medium buttons */
      --ui-text-xl:  1.0625rem;   /* 17px — large buttons */

      --space-1: 4px;
      --space-1-5: 6px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;
      --space-16: 64px;
      --space-20: 80px;

      --radius-sm: 10px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-xl: 32px;
      --radius-full: 9999px;

      /* Control Heights */
      --control-sm: 32px;
      --control-md: 36px;
      --control-lg: 44px;
      --control-xl: 56px;

      --motion-instant: 100ms;
      --motion-fast: 160ms;
      --motion-base: 240ms;
      --motion-slow: 360ms;
      --motion-deliberate: 500ms;
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
      --ease-smooth: cubic-bezier(0.22, 1, 0.36, 1);
      --ease-slam: cubic-bezier(0.55, 0.06, 0.68, 0.19);
      --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
      /* Spring easings — true multi-oscillation curves via linear() */
      --ease-spring-gentle: linear(
        0, 0.006, 0.025 2.8%, 0.101 6.1%, 0.539 18.9%,
        0.721 25.3%, 0.849 31.5%, 0.937 38.1%, 0.968 41.8%,
        0.991 45.7%, 1.006 50%, 1.015 55%, 1.017 63.9%,
        1.001 85.9%, 1
      );
      --ease-spring-bouncy: linear(
        0, 0.004, 0.016, 0.035, 0.063 9.1%,
        0.141, 0.25, 0.391, 0.563, 0.765, 1,
        0.891, 0.813 45.5%, 0.785, 0.766, 0.754, 0.75,
        0.754, 0.766, 0.785, 0.813 63.6%, 0.891, 1 72.7%,
        0.973, 0.953, 0.941, 0.938, 0.941, 0.953, 0.973, 1,
        0.988, 0.984, 0.988, 1
      );

      --btn-primary-bg: var(--accent-primary);
      --btn-primary-text: var(--text-on-accent);
      --btn-danger-bg: var(--accent-danger);
      --btn-danger-text: var(--text-on-accent);
      --btn-gold-bg: var(--accent-gold);
      --btn-gold-text: var(--text-on-gold);
      --btn-cyan-bg: var(--accent-cyan);
      --btn-cyan-text: var(--text-on-accent);
      --btn-green-bg: var(--accent-green);
      --btn-green-text: var(--text-on-accent);
      --btn-purple-bg: var(--accent-purple);
      --btn-purple-text: var(--text-on-accent);
      --btn-gap: var(--space-1-5);

      --badge-py: 2px;
      --badge-px: 10px;

      --toggle-off-bg: var(--primitive-neutral-300);
      --toggle-on-bg: var(--accent-primary);
      --toggle-knob: var(--primitive-neutral-0);

      /* Z-Index Scale */
      --z-base: 1;
      --z-sticky: 100;
      --z-fixed: 200;
      --z-overlay: 300;
      --z-modal: 1000;
      --z-toast: 1100;
      --z-tooltip: 1500;

      /* Container Widths */
      --container-sm: 640px;
      --container-md: 960px;
      --container-lg: 1200px;
    }
    } /* end @layer component (tokens) */

    /* ==========================================================================
       RESET & BASE
       ========================================================================== */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; scroll-padding-top: 72px; }
    body {
      font-family: var(--font-sans);
      font-size: var(--step-0);
      line-height: var(--leading-normal);
      color: var(--text-primary);
      background: var(--bg-page);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-feature-settings: "cv02", "cv03", "cv04", "cv11";
      overflow-x: clip;
    }
    :focus-visible { outline: 2px solid var(--focus-ring); outline-offset: 2px; }

    /* ==========================================================================
       SCROLL PROGRESS BAR
       ========================================================================== */
    .scroll-progress {
      position: fixed; top: 0; left: 0; right: 0; height: 3px;
      background: var(--accent-primary); transform-origin: left;
      z-index: var(--z-overlay);
    }
    @media (prefers-reduced-motion: no-preference) {
      @supports (animation-timeline: scroll()) {
        .scroll-progress {
          transform: scaleX(0);
          animation: scroll-progress-fill linear both;
          animation-timeline: scroll();
        }
        @keyframes scroll-progress-fill {
          0% { transform: scaleX(0); background-color: var(--accent-primary); }
          99% { background-color: var(--accent-primary); }
          100% { transform: scaleX(1); background-color: var(--accent-green); }
        }
      }
    }

    /* ==========================================================================
       NAV
       ========================================================================== */
    .topnav {
      position: fixed; top: 0; left: 0; right: 0; z-index: var(--z-fixed);
      background: oklch(0.995 0.004 70 / 0.88);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      border-bottom: 2px solid var(--border-subtle);
    }
    [data-theme="dark"] .topnav {
      background: oklch(0.165 0.015 65 / 0.88);
    }
    .topnav-inner {
      max-width: 1200px; margin: 0 auto;
      display: flex; align-items: center;
      padding: var(--space-3) var(--space-6); gap: var(--space-4);
    }
    .topnav-brand {
      display: flex; align-items: center; gap: var(--space-2);
      font-weight: 900; font-size: var(--step-1); letter-spacing: var(--tracking-tight);
      white-space: nowrap; text-decoration: none; color: var(--text-primary);
    }
    .brand-dots { display: flex; gap: 4px; }
    .brand-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .nav-links {
      display: flex; gap: var(--space-1); list-style: none;
      overflow-x: auto; flex: 1; scrollbar-width: none;
    }
    .nav-links::-webkit-scrollbar { display: none; }
    .nav-links a {
      font-size: var(--ui-text-sm); font-weight: 600; color: var(--text-secondary);
      text-decoration: none; padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm); white-space: nowrap;
      transition: transform var(--motion-instant) linear, color var(--motion-fast) var(--ease-out), background var(--motion-fast) var(--ease-out);
    }
    .nav-links a:hover { color: var(--text-primary); background: var(--bg-subtle); }
    .nav-links a:active { transform: translateY(1px); }
    .nav-right { display: flex; gap: var(--space-2); align-items: center; }
    .nav-btn {
      width: 36px; height: 36px; border-radius: var(--radius-sm);
      border: 2px solid var(--border-default); background: var(--bg-surface);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      color: var(--text-primary); text-decoration: none;
      transition: transform var(--motion-instant) linear, box-shadow var(--motion-instant) linear,
                  background var(--motion-fast) var(--ease-out);
    }
    .nav-btn:hover { transform: translateY(-1px); background: var(--bg-subtle); }
    .nav-btn:active { transform: translateY(1px); }
    .nav-btn svg { width: 18px; height: 18px; }
    .nav-kbd {
      font-size: var(--ui-text-xs); font-family: var(--font-sans);
      padding: 2px var(--space-1); border-radius: 4px;
      border: 1px solid var(--border-subtle); background: var(--bg-subtle);
      color: var(--text-muted); cursor: pointer; white-space: nowrap;
      transition: transform var(--motion-instant) linear, border-color var(--motion-fast) var(--ease-out);
    }
    .nav-kbd:hover { border-color: var(--border-default); }
    .nav-kbd:active { transform: translateY(1px); }
    .icon-sun { display: none; } .icon-moon { display: none; } .icon-monitor { display: none; }
    [data-theme="light"] .icon-sun { display: block; }
    [data-theme="dark"] .icon-moon { display: block; }
    [data-theme-mode="system"] .icon-sun, [data-theme-mode="system"] .icon-moon { display: none !important; }
    [data-theme-mode="system"] .icon-monitor { display: block; }
    @media (max-width: 768px) {
      .nav-links { display: none; }
      .topnav-inner { padding: var(--space-3) var(--space-4); }
    }

    /* ==========================================================================
       PAGE LAYOUT
       ========================================================================== */
    .page-wrap {
      max-width: 1200px; margin: 0 auto;
      padding: calc(56px + var(--space-8)) var(--space-6) var(--space-20);
    }

    /* ==========================================================================
       HERO
       ========================================================================== */
    .hero {
      text-align: center; padding: var(--space-8) 0 var(--space-12);
      position: relative;
    }
    .hero-canvas-wrap {
      position: relative; width: 100%; height: 340px;
      margin-bottom: var(--space-6);
      border: 2px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      overflow: hidden; background: var(--bg-subtle);
    }
    .hero-canvas {
      width: 100%; height: 100%; display: block;
    }
    .hero-canvas-hint {
      position: absolute; bottom: var(--space-3); left: 50%;
      transform: translateX(-50%);
      font-size: var(--ui-text-xs); color: var(--text-muted);
      background: var(--bg-surface); border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full); padding: 2px var(--space-3);
      pointer-events: none; opacity: 0.8;
    }
    .hero-title {
      font-size: var(--step-5); font-weight: 900;
      letter-spacing: var(--tracking-tightest);
      line-height: var(--leading-none);
      margin-bottom: var(--space-4);
    }
    .hero-subtitle {
      font-size: var(--step-1); color: var(--text-secondary);
      max-width: 640px; margin: 0 auto var(--space-4);
      line-height: var(--leading-snug);
    }
    .hero-crosslink {
      font-size: var(--ui-text-sm); color: var(--text-muted);
      margin-bottom: var(--space-4);
    }
    .hero-crosslink a {
      color: var(--accent-primary-text); text-decoration: underline;
      text-underline-offset: 2px;
    }
    .hero-dots {
      display: flex; justify-content: center; gap: var(--space-3);
    }
    .hero-dot {
      width: 12px; height: 12px; border-radius: 50%;
      border: 2px solid var(--border-default);
    }

    /* ==========================================================================
       SECTION LAYOUT
       ========================================================================== */
    .anim-section {
      margin-bottom: var(--space-16);
      padding-bottom: var(--space-16);
      border-bottom: 2px dashed var(--border-subtle);
      content-visibility: auto;
      contain-intrinsic-size: auto 600px;
    }
    .anim-section:last-of-type { border-bottom: none; }
    .section-header { margin-bottom: var(--space-8); }
    .section-overline {
      font-size: var(--ui-text-xs); font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.08em;
      color: var(--text-muted); margin-bottom: var(--space-2);
      display: flex; align-items: center; gap: var(--space-2);
    }
    .status-dot {
      width: 8px; height: 8px; border-radius: 50%; display: inline-block;
    }
    .section-title {
      font-size: var(--step-3); font-weight: 800;
      letter-spacing: var(--tracking-tight);
      line-height: var(--leading-tight);
      margin-bottom: var(--space-2);
    }
    .section-desc {
      font-size: var(--step-0); color: var(--text-secondary);
      max-width: 640px; line-height: var(--leading-normal);
    }

    /* ==========================================================================
       DEMO CARD
       ========================================================================== */
    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(min(340px, 100%), 1fr));
      gap: var(--space-6);
    }
    .demo-card {
      background: var(--bg-surface);
      border: 2px solid var(--border-default);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      overflow: hidden; display: flex; flex-direction: column;
    }
    .demo-card-stage {
      padding: var(--space-6);
      display: flex; align-items: center; justify-content: center;
      background: var(--bg-subtle);
      border-bottom: 2px solid var(--border-subtle);
      min-height: 200px; position: relative; overflow: hidden;
    }
    .demo-card-stage canvas {
      width: 100%; height: 100%; display: block;
      position: absolute; inset: 0;
    }
    .demo-card-body {
      padding: var(--space-4); flex: 1;
      display: flex; flex-direction: column;
    }
    .demo-card-top {
      display: flex; align-items: center; gap: var(--space-2);
      margin-bottom: var(--space-2);
    }
    .demo-card-top .demo-card-tags {
      margin-left: auto; margin-bottom: 0;
    }
    .demo-card-name {
      font-family: var(--font-mono); font-size: var(--ui-text-md);
      font-weight: 700; color: var(--text-primary);
    }
    .demo-card-desc {
      font-size: var(--ui-text-sm); color: var(--text-secondary);
      line-height: var(--leading-normal); margin-bottom: var(--space-3);
    }
    .demo-card-hint {
      font-size: var(--ui-text-xs); color: var(--text-muted);
      font-style: italic;
    }
    .demo-card-tags {
      display: flex; gap: var(--space-1); flex-wrap: wrap;
      margin-bottom: var(--space-2);
    }
    .tag {
      font-size: var(--ui-text-2xs); font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.04em;
      padding: 2px 10px; border: 2px solid var(--border-default);
      border-radius: var(--radius-full); color: var(--text-secondary);
    }
    .demo-btn {
      background: var(--accent-primary); color: var(--text-on-accent);
      border: 2px solid var(--border-default); border-radius: var(--radius-sm);
      font-family: var(--font-sans); font-size: var(--ui-text-xs);
      font-weight: 700; padding: var(--space-1) var(--space-3);
      cursor: pointer; white-space: nowrap;
      transition: transform var(--motion-instant) linear, box-shadow var(--motion-instant) linear;
    }
    .demo-btn:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .demo-btn:active { box-shadow: 0 0 0 var(--text-primary); transform: translate(2px, 2px); }
    .demo-btn-secondary {
      background: var(--bg-surface); color: var(--text-primary);
    }

    /* Wide demo card (full width) */
    .demo-card-wide { grid-column: 1 / -1; }
    .demo-card-wide .demo-card-stage { min-height: 300px; }

    /* Slider controls */
    .demo-controls {
      display: flex; gap: var(--space-4); flex-wrap: wrap;
      padding: var(--space-3) var(--space-4);
      border-top: 2px solid var(--border-subtle);
      background: var(--bg-muted);
    }
    .demo-control-group {
      display: flex; flex-direction: column; gap: 2px; flex: 1; min-width: 120px;
    }
    .demo-control-label {
      font-size: var(--ui-text-2xs); font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.04em;
      color: var(--text-muted); display: flex; justify-content: space-between;
    }
    .demo-control-label span { color: var(--accent-primary-text); font-family: var(--font-mono); }
    input[type="range"] {
      width: 100%; height: 6px; appearance: none;
      background: var(--border-subtle); border-radius: var(--radius-full);
      outline: none; cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none; width: 16px; height: 16px;
      border-radius: 50%; background: var(--accent-primary);
      border: 2px solid var(--border-default); cursor: pointer;
    }

    /* ==========================================================================
       FOOTER
       ========================================================================== */
    .ds-footer {
      text-align: center; padding: var(--space-12) var(--space-6);
      color: var(--text-secondary); border-top: 2px dashed var(--border-subtle);
    }
    .ds-footer a {
      color: var(--accent-primary-text); text-decoration: underline;
      text-underline-offset: 2px;
    }
    .ds-footer a:hover { color: var(--accent-primary); }

    /* ==========================================================================
       BACK TO TOP
       ========================================================================== */
    .back-to-top {
      position: fixed; bottom: var(--space-6); right: var(--space-6);
      z-index: var(--z-fixed); width: 44px; height: 44px;
      border-radius: var(--radius-sm); border: 2px solid var(--border-default);
      background: var(--bg-elevated); color: var(--text-primary);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      box-shadow: var(--shadow-sm);
      opacity: 0; pointer-events: none;
      transition: opacity var(--motion-fast) var(--ease-out), transform var(--motion-instant) linear, box-shadow var(--motion-instant) linear;
    }
    .back-to-top.visible { opacity: 1; pointer-events: auto; }
    .back-to-top:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .back-to-top:active { transform: translateY(1px); box-shadow: none; }
    .back-to-top svg { width: 20px; height: 20px; }

    /* View transitions */
    ::view-transition-old(root),
    ::view-transition-new(root) { animation-duration: 240ms; }

    /* ==========================================================================
       COMMAND PALETTE
       ========================================================================== */
    .cmd-palette-overlay {
      position: fixed; inset: 0; z-index: var(--z-modal);
      background: var(--overlay-bg);
      display: none; align-items: flex-start; justify-content: center;
      padding-top: 20vh; opacity: 0;
      transition: opacity 200ms var(--ease-out), display 200ms var(--ease-out) allow-discrete;
    }
    .cmd-palette-overlay.active {
      display: flex; opacity: 1;
      @starting-style { opacity: 0; }
    }
    .cmd-palette {
      width: 100%; max-width: 520px;
      background: var(--bg-elevated); border: 2px solid var(--border-default);
      border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);
      overflow: hidden;
      transform: scale(0.95) translateY(-10px); opacity: 0;
      transition: transform 240ms var(--ease-smooth), opacity 240ms var(--ease-smooth);
    }
    .cmd-palette-overlay.active .cmd-palette {
      transform: scale(1) translateY(0); opacity: 1;
      @starting-style { transform: scale(0.95) translateY(-10px); opacity: 0; }
    }
    .cmd-palette-input {
      width: 100%; padding: var(--space-4) var(--space-6);
      font-family: var(--font-sans); font-size: var(--step-0);
      border: none; border-bottom: 2px solid var(--border-subtle);
      background: transparent; color: var(--text-primary); outline: none;
    }
    .cmd-palette-input::placeholder { color: var(--text-muted); }
    .cmd-palette-list {
      list-style: none; max-height: 320px; overflow-y: auto;
      padding: var(--space-2) 0;
    }
    .cmd-palette-item {
      padding: var(--space-2) var(--space-6);
      font-size: var(--ui-text-md); color: var(--text-secondary);
      cursor: pointer; display: flex; align-items: center; gap: var(--space-3);
      transition: transform var(--motion-instant) linear, background var(--motion-fast) var(--ease-out), color var(--motion-fast) var(--ease-out);
    }
    .cmd-palette-item:hover,
    .cmd-palette-item.active {
      background: var(--bg-subtle); color: var(--text-primary);
    }
    .cmd-palette-item:active { transform: translateY(1px); }
    .cmd-palette-item .cmd-section-dot {
      width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0;
    }
    .cmd-palette-empty {
      padding: var(--space-4) var(--space-6);
      color: var(--text-muted); font-size: var(--ui-text-sm); text-align: center;
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
      .hero-canvas-wrap { display: none; }
      .demo-card-stage canvas { opacity: 0.4; }
      .demo-card-hint::after {
        content: ' (animations paused — reduced motion enabled)';
      }
    }

    /* Screen reader only */
    .sr-only {
      position: absolute; width: 1px; height: 1px;
      padding: 0; margin: -1px; overflow: hidden;
      clip: rect(0, 0, 0, 0); white-space: nowrap;
      border-width: 0;
    }

    /* Print styles */
    @media print {
      .topnav, .back-to-top, .cmd-palette-overlay, .scroll-progress,
      .demo-card-stage canvas, .hero-canvas-wrap { display: none; }
      body { background: white; color: black; }
      .demo-card { break-inside: avoid; box-shadow: none; border: 1px solid #ccc; }
    }
  </style>
</head>

<body>
  <div class="scroll-progress" aria-hidden="true"></div>

  <!-- NAV -->
  <nav class="topnav" role="navigation" aria-label="Animation system navigation">
    <div class="topnav-inner">
      <a href="#" class="topnav-brand">
        <span class="brand-dots">
          <span class="brand-dot" style="background:var(--accent-primary)"></span>
          <span class="brand-dot" style="background:var(--accent-gold)"></span>
          <span class="brand-dot" style="background:var(--accent-cyan)"></span>
        </span>
        Delightful Animation
      </a>
      <ul class="nav-links">
        <li><a href="#springs">Springs</a></li>
        <li><a href="#particles">Particles</a></li>
        <li><a href="#flip">FLIP</a></li>
        <li><a href="#gestures">Gestures</a></li>
        <li><a href="#cursor">Cursor</a></li>
        <li><a href="#generative">Generative</a></li>
        <li><a href="#components">Components</a></li>
        <li><a href="#combined">Combined</a></li>
      </ul>
      <div class="nav-right">
        <kbd class="nav-kbd" id="cmd-k-trigger" title="Quick navigation">&#8984;K</kbd>
        <a href="delightful-design-system.html" class="nav-btn" aria-label="Design System" title="Design System">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        </a>
        <a href="delightful-motion.html" class="nav-btn" aria-label="Motion System" title="Motion System">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M5 12h14"/><polyline points="12 5 19 12 12 19"/></svg>
        </a>
        <button class="nav-btn" id="theme-toggle" aria-label="Toggle theme (light / dark / system)">
          <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
          <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
          </svg>
          <svg class="icon-monitor" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>
          </svg>
        </button>
      </div>
    </div>
  </nav>

  <div class="page-wrap">

    <!-- HERO -->
    <section class="hero">
      <div class="hero-canvas-wrap" role="img" aria-label="Interactive particle constellation with 60 colorful particles connected by spring-physics lines. Particles respond to mouse movement and clicks.">
        <canvas class="hero-canvas" id="hero-canvas" aria-hidden="true"></canvas>
        <span class="hero-canvas-hint">Move mouse or touch to interact</span>
      </div>
      <h1 class="hero-title">Delightful Animation</h1>
      <p class="hero-subtitle">Spring physics, particle systems, generative art, and interactive playgrounds — all vanilla JS, all token-driven.</p>
      <p class="hero-crosslink">Part of the <a href="delightful-design-system.html">Delightful Design System</a> &middot; <a href="delightful-motion.html">Motion</a> &middot; <a href="delightful-color.html">Color</a></p>
      <div class="hero-dots">
        <span class="hero-dot" style="background:var(--accent-primary)"></span>
        <span class="hero-dot" style="background:var(--accent-gold)"></span>
        <span class="hero-dot" style="background:var(--accent-cyan)"></span>
      </div>
    </section>

    <!-- ================================================================
         1. SPRING PHYSICS
         ================================================================ -->
    <section id="springs" class="anim-section">
      <div class="section-header">
        <div class="section-overline"><span class="status-dot" style="background:var(--accent-primary)"></span> Category 01</div>
        <h2 class="section-title">Spring Physics</h2>
        <p class="section-desc">Damped harmonic oscillators bring natural, organic motion to UI elements. Press, drag, and tweak parameters in real time.</p>
      </div>

      <div class="demo-grid">
        <!-- Spring Button -->
        <div class="demo-card">
          <div class="demo-card-stage" id="spring-btn-stage" style="cursor:pointer" tabindex="0" role="button" aria-label="Spring button demo. Press Space or Enter to activate.">
            <div id="spring-btn-el" style="
              width:160px;height:56px;display:flex;align-items:center;justify-content:center;
              background:var(--accent-primary);color:var(--text-on-accent);
              border:2px solid var(--border-default);border-radius:var(--radius-sm);
              box-shadow:var(--shadow-md);font-weight:700;font-size:var(--ui-text-md);
              user-select:none;pointer-events:none;
            ">Press Me</div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">spring-button</span>
              <span class="demo-card-tags"><span class="tag">Spring</span></span>
            </div>
            <p class="demo-card-desc">Click to compress with spring physics. Release bounces back with overshoot.</p>
            <p class="demo-card-hint">Click or tap the button</p>
          </div>
        </div>

        <!-- Spring Chain -->
        <div class="demo-card">
          <div class="demo-card-stage">
            <canvas id="spring-chain-canvas" aria-label="Spring chain: linked circles connected by springs that follow mouse"></canvas>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">spring-chain</span>
              <span class="demo-card-tags"><span class="tag">Spring</span></span>
            </div>
            <p class="demo-card-desc">Linked elements connected by springs. The leader follows the cursor, trailing nodes follow with cascading delay.</p>
            <p class="demo-card-hint">Move mouse over the canvas</p>
          </div>
        </div>

        <!-- Spring Parameters Playground -->
        <div class="demo-card demo-card-wide">
          <div class="demo-card-stage" id="spring-params-stage">
            <canvas id="spring-params-canvas" aria-label="Spring parameters playground with adjustable stiffness, damping, and mass"></canvas>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">spring-playground</span>
              <span class="demo-card-tags"><span class="tag">Spring</span><span class="tag">Interactive</span></span>
            </div>
            <p class="demo-card-desc">Adjust stiffness, damping, and mass to see how spring parameters affect motion. Click the canvas to set a new target position.</p>
          </div>
          <div class="demo-controls">
            <div class="demo-control-group">
              <label class="demo-control-label">Stiffness <span id="spring-stiffness-val">180</span></label>
              <input type="range" id="spring-stiffness" min="20" max="600" value="180" />
            </div>
            <div class="demo-control-group">
              <label class="demo-control-label">Damping <span id="spring-damping-val">12</span></label>
              <input type="range" id="spring-damping" min="1" max="40" value="12" />
            </div>
            <div class="demo-control-group">
              <label class="demo-control-label">Mass <span id="spring-mass-val">1.0</span></label>
              <input type="range" id="spring-mass" min="0.1" max="5" step="0.1" value="1" />
            </div>
          </div>
        </div>

        <!-- Spring Toggle -->
        <div class="demo-card">
          <div class="demo-card-stage" id="spring-toggle-stage" style="display:flex;gap:var(--space-8);align-items:center;justify-content:center;padding:var(--space-8)">
            <div style="display:flex;flex-direction:column;align-items:center;gap:var(--space-2)">
              <button id="spring-toggle-0" role="switch" aria-checked="false" aria-label="Notifications toggle" style="width:56px;height:30px;border-radius:var(--radius-full);background:var(--primitive-neutral-300);border:2px solid var(--border-default);box-shadow:var(--shadow-sm);position:relative;cursor:pointer;flex-shrink:0;padding:0;transition:none;">
                <span style="position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:var(--primitive-neutral-0);border:2px solid var(--border-default);box-shadow:1px 1px 0 var(--border-default);display:block;will-change:transform;"></span>
              </button>
              <span style="font-size:var(--ui-text-xs);color:var(--text-muted);font-weight:600">Alerts</span>
            </div>
            <div style="display:flex;flex-direction:column;align-items:center;gap:var(--space-2)">
              <button id="spring-toggle-1" role="switch" aria-checked="true" aria-label="Sync toggle" style="width:56px;height:30px;border-radius:var(--radius-full);background:var(--accent-green);border:2px solid var(--border-default);box-shadow:var(--shadow-sm);position:relative;cursor:pointer;flex-shrink:0;padding:0;transition:none;">
                <span style="position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:var(--primitive-neutral-0);border:2px solid var(--border-default);box-shadow:1px 1px 0 var(--border-default);display:block;will-change:transform;transform:translateX(26px);"></span>
              </button>
              <span style="font-size:var(--ui-text-xs);color:var(--text-muted);font-weight:600">Sync</span>
            </div>
            <div style="display:flex;flex-direction:column;align-items:center;gap:var(--space-2)">
              <button id="spring-toggle-2" role="switch" aria-checked="false" aria-label="Dark mode toggle" style="width:56px;height:30px;border-radius:var(--radius-full);background:var(--primitive-neutral-300);border:2px solid var(--border-default);box-shadow:var(--shadow-sm);position:relative;cursor:pointer;flex-shrink:0;padding:0;transition:none;">
                <span style="position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:var(--primitive-neutral-0);border:2px solid var(--border-default);box-shadow:1px 1px 0 var(--border-default);display:block;will-change:transform;"></span>
              </button>
              <span style="font-size:var(--ui-text-xs);color:var(--text-muted);font-weight:600">Dark</span>
            </div>
            <div style="display:flex;flex-direction:column;align-items:center;gap:var(--space-2)">
              <button id="spring-toggle-3" role="switch" aria-checked="true" aria-label="AI features toggle" style="width:56px;height:30px;border-radius:var(--radius-full);background:var(--accent-purple);border:2px solid var(--border-default);box-shadow:var(--shadow-sm);position:relative;cursor:pointer;flex-shrink:0;padding:0;transition:none;">
                <span style="position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:var(--primitive-neutral-0);border:2px solid var(--border-default);box-shadow:1px 1px 0 var(--border-default);display:block;will-change:transform;transform:translateX(26px);"></span>
              </button>
              <span style="font-size:var(--ui-text-xs);color:var(--text-muted);font-weight:600">AI</span>
            </div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">spring-toggle</span>
              <span class="demo-card-tags"><span class="tag">Spring</span><span class="tag">DOM</span></span>
            </div>
            <p class="demo-card-desc">Toggle switches animated with a damped spring. The knob overshoots on click and settles with bounce — driven by springStep(), not CSS transitions.</p>
            <p class="demo-card-hint">Click any toggle to switch it</p>
          </div>
        </div>

        <!-- Spring Accordion -->
        <div class="demo-card demo-card-wide">
          <div class="demo-card-stage" style="min-height:auto;padding:var(--space-4)">
            <div id="spring-accordion" style="width:100%;display:flex;flex-direction:column;gap:var(--space-2)">
              <div class="sacc-panel" style="border:2px solid var(--border-default);border-radius:var(--radius-sm);overflow:hidden;background:var(--bg-surface)">
                <button class="sacc-header" aria-expanded="false" style="width:100%;display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--accent-primary-subtle);border:none;cursor:pointer;font-family:var(--font-sans);font-size:var(--ui-text-md);font-weight:700;color:var(--text-primary);text-align:left">
                  <span style="width:8px;height:8px;border-radius:50%;background:var(--accent-primary);flex-shrink:0"></span>
                  Spring Physics
                  <span class="sacc-chevron" style="margin-left:auto;font-size:var(--ui-text-xs);transition:none">&#9660;</span>
                </button>
                <div class="sacc-body" style="height:0;overflow:hidden">
                  <div class="sacc-inner" style="padding:var(--space-3) var(--space-4);font-size:var(--ui-text-sm);color:var(--text-secondary);line-height:var(--leading-normal)">
                    Damped harmonic oscillators bring natural, organic motion. Every interactive element uses <code style="font-family:var(--font-mono);background:var(--bg-muted);padding:1px 4px;border-radius:4px">springStep()</code> for physically grounded animation.
                  </div>
                </div>
              </div>
              <div class="sacc-panel" style="border:2px solid var(--border-default);border-radius:var(--radius-sm);overflow:hidden;background:var(--bg-surface)">
                <button class="sacc-header" aria-expanded="false" style="width:100%;display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--accent-gold-subtle);border:none;cursor:pointer;font-family:var(--font-sans);font-size:var(--ui-text-md);font-weight:700;color:var(--text-primary);text-align:left">
                  <span style="width:8px;height:8px;border-radius:50%;background:var(--accent-gold);flex-shrink:0"></span>
                  Token Architecture
                  <span class="sacc-chevron" style="margin-left:auto;font-size:var(--ui-text-xs);transition:none">&#9660;</span>
                </button>
                <div class="sacc-body" style="height:0;overflow:hidden">
                  <div class="sacc-inner" style="padding:var(--space-3) var(--space-4);font-size:var(--ui-text-sm);color:var(--text-secondary);line-height:var(--leading-normal)">
                    Three-tier token system: Primitives define raw OKLCH values, Semantic tokens map to meaning, Component tokens style specific UI elements. Never skip a tier.
                  </div>
                </div>
              </div>
              <div class="sacc-panel" style="border:2px solid var(--border-default);border-radius:var(--radius-sm);overflow:hidden;background:var(--bg-surface)">
                <button class="sacc-header" aria-expanded="false" style="width:100%;display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--accent-cyan-subtle);border:none;cursor:pointer;font-family:var(--font-sans);font-size:var(--ui-text-md);font-weight:700;color:var(--text-primary);text-align:left">
                  <span style="width:8px;height:8px;border-radius:50%;background:var(--accent-cyan);flex-shrink:0"></span>
                  Neo-Brutalist Style
                  <span class="sacc-chevron" style="margin-left:auto;font-size:var(--ui-text-xs);transition:none">&#9660;</span>
                </button>
                <div class="sacc-body" style="height:0;overflow:hidden">
                  <div class="sacc-inner" style="padding:var(--space-3) var(--space-4);font-size:var(--ui-text-sm);color:var(--text-secondary);line-height:var(--leading-normal)">
                    Solid shadows (zero blur), 2px borders, bold typography, and high-contrast color. No gradients on UI elements — flat fills with hard edges.
                  </div>
                </div>
              </div>
              <div class="sacc-panel" style="border:2px solid var(--border-default);border-radius:var(--radius-sm);overflow:hidden;background:var(--bg-surface)">
                <button class="sacc-header" aria-expanded="false" style="width:100%;display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--accent-purple-subtle);border:none;cursor:pointer;font-family:var(--font-sans);font-size:var(--ui-text-md);font-weight:700;color:var(--text-primary);text-align:left">
                  <span style="width:8px;height:8px;border-radius:50%;background:var(--accent-purple);flex-shrink:0"></span>
                  Reduced Motion
                  <span class="sacc-chevron" style="margin-left:auto;font-size:var(--ui-text-xs);transition:none">&#9660;</span>
                </button>
                <div class="sacc-body" style="height:0;overflow:hidden">
                  <div class="sacc-inner" style="padding:var(--space-3) var(--space-4);font-size:var(--ui-text-sm);color:var(--text-secondary);line-height:var(--leading-normal)">
                    When <code style="font-family:var(--font-mono);background:var(--bg-muted);padding:1px 4px;border-radius:4px">prefers-reduced-motion</code> is active, all spring animations snap instantly to their targets. Every demo respects this preference.
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">spring-accordion</span>
              <span class="demo-card-tags"><span class="tag">Spring</span><span class="tag">DOM</span></span>
            </div>
            <p class="demo-card-desc">Accordion panels with spring-animated height. Only one panel opens at a time — opening one springs the previous closed with bouncy overshoot.</p>
            <p class="demo-card-hint">Click a panel header to expand it</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ================================================================
         2. PARTICLE SYSTEMS
         ================================================================ -->
    <section id="particles" class="anim-section">
      <div class="section-header">
        <div class="section-overline"><span class="status-dot" style="background:var(--accent-gold)"></span> Category 02</div>
        <h2 class="section-title">Particle Systems</h2>
        <p class="section-desc">Object-pooled particle engines for confetti, fireworks, and token-colored bubbles. All running at 60fps with recycled particles.</p>
      </div>

      <div class="demo-grid">
        <!-- Confetti Cannon -->
        <div class="demo-card">
          <div class="demo-card-stage" style="min-height:240px">
            <canvas id="confetti-canvas" aria-label="Confetti cannon: click to fire colorful confetti particles"></canvas>
            <button class="demo-btn" id="confetti-fire" style="position:absolute;bottom:var(--space-3);left:50%;transform:translateX(-50%);z-index:2">Fire!</button>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">confetti-cannon</span>
              <span class="demo-card-tags"><span class="tag">Particles</span></span>
            </div>
            <p class="demo-card-desc">Click to launch a burst of confetti with gravity, rotation, and air resistance. Particles are pooled and recycled.</p>
            <p class="demo-card-hint">Click the Fire button or the canvas</p>
          </div>
        </div>

        <!-- Fireworks -->
        <div class="demo-card">
          <div class="demo-card-stage" style="min-height:240px;background:var(--bg-page)">
            <canvas id="fireworks-canvas" aria-label="Fireworks: click to launch multi-phase firework particles with trails"></canvas>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">fireworks</span>
              <span class="demo-card-tags"><span class="tag">Particles</span></span>
            </div>
            <p class="demo-card-desc">Multi-phase particles: a rocket launches up, then explodes into trailing sparks with color shifts.</p>
            <p class="demo-card-hint">Click anywhere on the canvas</p>
          </div>
        </div>

        <!-- Token Bubbles -->
        <div class="demo-card">
          <div class="demo-card-stage" style="min-height:280px">
            <canvas id="token-bubbles-canvas" aria-label="Token bubbles: floating circles representing each color family"></canvas>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">token-bubbles</span>
              <span class="demo-card-tags"><span class="tag">Particles</span><span class="tag">Canvas</span></span>
            </div>
            <p class="demo-card-desc">Seven gently floating circles — one per color family — labeled with their names. Click a bubble to spring-scale it and emit micro-particles.</p>
            <p class="demo-card-hint">Click a bubble to pop it</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ================================================================
         3. FLIP & LAYOUT
         ================================================================ -->
    <section id="flip" class="anim-section">
      <div class="section-header">
        <div class="section-overline"><span class="status-dot" style="background:var(--accent-green)"></span> Category 03</div>
        <h2 class="section-title">FLIP &amp; Layout Animation</h2>
        <p class="section-desc">First-Last-Invert-Play technique for smooth layout transitions. Elements animate from where they were to where they are.</p>
      </div>

      <div class="demo-grid">
        <!-- Card Shuffle -->
        <div class="demo-card demo-card-wide">
          <div class="demo-card-stage" style="min-height:auto;padding:var(--space-6)">
            <div id="flip-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:var(--space-3);width:100%">
              <div class="flip-card" data-id="1" style="height:80px;background:var(--accent-primary-subtle);border:2px solid var(--accent-primary);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:var(--step-1);color:var(--accent-primary-text);cursor:default">1</div>
              <div class="flip-card" data-id="2" style="height:80px;background:var(--accent-gold-subtle);border:2px solid var(--accent-gold);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:var(--step-1);color:var(--accent-gold-text);cursor:default">2</div>
              <div class="flip-card" data-id="3" style="height:80px;background:var(--accent-cyan-subtle);border:2px solid var(--accent-cyan);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:var(--step-1);color:var(--accent-cyan-text);cursor:default">3</div>
              <div class="flip-card" data-id="4" style="height:80px;background:var(--accent-danger-subtle);border:2px solid var(--accent-danger);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:var(--step-1);color:var(--accent-danger-text);cursor:default">4</div>
              <div class="flip-card" data-id="5" style="height:80px;background:var(--accent-green-subtle);border:2px solid var(--accent-green);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:var(--step-1);color:var(--accent-green-text);cursor:default">5</div>
              <div class="flip-card" data-id="6" style="height:80px;background:var(--accent-purple-subtle);border:2px solid var(--accent-purple);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:var(--step-1);color:var(--accent-purple-text);cursor:default">6</div>
              <div class="flip-card" data-id="7" style="height:80px;background:var(--accent-primary-subtle);border:2px solid var(--accent-primary);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:var(--step-1);color:var(--accent-primary-text);cursor:default">7</div>
              <div class="flip-card" data-id="8" style="height:80px;background:var(--accent-gold-subtle);border:2px solid var(--accent-gold);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:var(--step-1);color:var(--accent-gold-text);cursor:default">8</div>
            </div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">card-shuffle</span>
              <button class="demo-btn" id="flip-shuffle-btn">Shuffle</button>
            </div>
            <p class="demo-card-desc">FLIP-animated card reordering. Records positions, shuffles DOM, then animates from old positions to new.</p>
            <p class="demo-card-hint">Click Shuffle to see FLIP in action</p>
          </div>
        </div>

        <!-- FLIP Filter Grid -->
        <div class="demo-card demo-card-wide">
          <div class="demo-card-stage" style="min-height:auto;padding:var(--space-4)">
            <div style="width:100%">
              <div id="filter-btns" style="display:flex;gap:var(--space-2);flex-wrap:wrap;margin-bottom:var(--space-4)">
                <button data-filter="all" class="demo-btn active" style="font-size:var(--ui-text-xs)">All</button>
                <button data-filter="pink" class="demo-btn demo-btn-secondary" style="font-size:var(--ui-text-xs)">Pink</button>
                <button data-filter="gold" class="demo-btn demo-btn-secondary" style="font-size:var(--ui-text-xs)">Gold</button>
                <button data-filter="cyan" class="demo-btn demo-btn-secondary" style="font-size:var(--ui-text-xs)">Cyan</button>
                <button data-filter="green" class="demo-btn demo-btn-secondary" style="font-size:var(--ui-text-xs)">Green</button>
                <button data-filter="purple" class="demo-btn demo-btn-secondary" style="font-size:var(--ui-text-xs)">Purple</button>
                <button data-filter="danger" class="demo-btn demo-btn-secondary" style="font-size:var(--ui-text-xs)">Red</button>
              </div>
              <div id="filter-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:var(--space-3)">
                <div data-color="pink" style="height:70px;background:var(--accent-primary-subtle);border:2px solid var(--accent-primary);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-primary-text)">Pink</div>
                <div data-color="gold" style="height:70px;background:var(--accent-gold-subtle);border:2px solid var(--accent-gold);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-gold-text)">Gold</div>
                <div data-color="cyan" style="height:70px;background:var(--accent-cyan-subtle);border:2px solid var(--accent-cyan);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-cyan-text)">Cyan</div>
                <div data-color="green" style="height:70px;background:var(--accent-green-subtle);border:2px solid var(--accent-green);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-green-text)">Green</div>
                <div data-color="purple" style="height:70px;background:var(--accent-purple-subtle);border:2px solid var(--accent-purple);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-purple-text)">Purple</div>
                <div data-color="danger" style="height:70px;background:var(--accent-danger-subtle);border:2px solid var(--accent-danger);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-danger-text)">Red</div>
                <div data-color="pink" style="height:70px;background:var(--accent-primary-subtle);border:2px solid var(--accent-primary);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-primary-text)">Pink</div>
                <div data-color="gold" style="height:70px;background:var(--accent-gold-subtle);border:2px solid var(--accent-gold);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-gold-text)">Gold</div>
                <div data-color="cyan" style="height:70px;background:var(--accent-cyan-subtle);border:2px solid var(--accent-cyan);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-cyan-text)">Cyan</div>
                <div data-color="green" style="height:70px;background:var(--accent-green-subtle);border:2px solid var(--accent-green);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-green-text)">Green</div>
                <div data-color="purple" style="height:70px;background:var(--accent-purple-subtle);border:2px solid var(--accent-purple);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-purple-text)">Purple</div>
                <div data-color="danger" style="height:70px;background:var(--accent-danger-subtle);border:2px solid var(--accent-danger);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-danger-text)">Red</div>
              </div>
            </div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">flip-filter-grid</span>
              <span class="demo-card-tags"><span class="tag">FLIP</span><span class="tag">Filter</span></span>
            </div>
            <p class="demo-card-desc">A grid of color chips with filter buttons. Clicking a filter FLIP-animates matching cards into new positions while non-matching scale to zero.</p>
            <p class="demo-card-hint">Click a filter button</p>
          </div>
        </div>

        <!-- FLIP Reorder List -->
        <div class="demo-card demo-card-wide">
          <div class="demo-card-stage" style="min-height:auto;padding:var(--space-4)">
            <div style="width:100%;max-width:400px">
              <div id="reorder-list" style="display:flex;flex-direction:column;gap:var(--space-2)">
                <div class="reorder-item" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-2) var(--space-3);background:var(--accent-green-subtle);border:2px solid var(--accent-green);border-radius:var(--radius-sm);font-weight:700;font-size:var(--ui-text-sm)">
                  <span style="color:var(--accent-green-text);flex:1">Emerald</span>
                  <button class="reorder-up demo-btn demo-btn-secondary" style="padding:2px 8px;font-size:10px">&#9650;</button>
                  <button class="reorder-down demo-btn demo-btn-secondary" style="padding:2px 8px;font-size:10px">&#9660;</button>
                </div>
                <div class="reorder-item" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-2) var(--space-3);background:var(--accent-gold-subtle);border:2px solid var(--accent-gold);border-radius:var(--radius-sm);font-weight:700;font-size:var(--ui-text-sm)">
                  <span style="color:var(--accent-gold-text);flex:1">Amber</span>
                  <button class="reorder-up demo-btn demo-btn-secondary" style="padding:2px 8px;font-size:10px">&#9650;</button>
                  <button class="reorder-down demo-btn demo-btn-secondary" style="padding:2px 8px;font-size:10px">&#9660;</button>
                </div>
                <div class="reorder-item" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-2) var(--space-3);background:var(--accent-danger-subtle);border:2px solid var(--accent-danger);border-radius:var(--radius-sm);font-weight:700;font-size:var(--ui-text-sm)">
                  <span style="color:var(--accent-danger-text);flex:1">Coral</span>
                  <button class="reorder-up demo-btn demo-btn-secondary" style="padding:2px 8px;font-size:10px">&#9650;</button>
                  <button class="reorder-down demo-btn demo-btn-secondary" style="padding:2px 8px;font-size:10px">&#9660;</button>
                </div>
                <div class="reorder-item" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-2) var(--space-3);background:var(--accent-cyan-subtle);border:2px solid var(--accent-cyan);border-radius:var(--radius-sm);font-weight:700;font-size:var(--ui-text-sm)">
                  <span style="color:var(--accent-cyan-text);flex:1">Sapphire</span>
                  <button class="reorder-up demo-btn demo-btn-secondary" style="padding:2px 8px;font-size:10px">&#9650;</button>
                  <button class="reorder-down demo-btn demo-btn-secondary" style="padding:2px 8px;font-size:10px">&#9660;</button>
                </div>
                <div class="reorder-item" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-2) var(--space-3);background:var(--accent-purple-subtle);border:2px solid var(--accent-purple);border-radius:var(--radius-sm);font-weight:700;font-size:var(--ui-text-sm)">
                  <span style="color:var(--accent-purple-text);flex:1">Orchid</span>
                  <button class="reorder-up demo-btn demo-btn-secondary" style="padding:2px 8px;font-size:10px">&#9650;</button>
                  <button class="reorder-down demo-btn demo-btn-secondary" style="padding:2px 8px;font-size:10px">&#9660;</button>
                </div>
              </div>
            </div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">flip-reorder-list</span>
              <button class="demo-btn" id="reorder-sort-btn">Sort A-Z</button>
            </div>
            <p class="demo-card-desc">A vertical list with up/down arrows. Clicking swaps items with FLIP animation. Sort A-Z reorders all at once.</p>
            <p class="demo-card-hint">Click arrows or Sort A-Z</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ================================================================
         4. GESTURES & DRAG
         ================================================================ -->
    <section id="gestures" class="anim-section">
      <div class="section-header">
        <div class="section-overline"><span class="status-dot" style="background:var(--accent-primary)"></span> Category 04</div>
        <h2 class="section-title">Gestures &amp; Drag</h2>
        <p class="section-desc">Unified pointer event handling for drag with inertia, swipe-to-dismiss, and elastic overscroll.</p>
      </div>

      <div class="demo-grid">
        <!-- Draggable Cards -->
        <div class="demo-card demo-card-wide">
          <div class="demo-card-stage" id="drag-stage" style="min-height:260px;cursor:grab">
            <div class="drag-card" style="
              position:absolute;left:60px;top:40px;width:100px;height:140px;
              background:var(--accent-primary-subtle);border:2px solid var(--accent-primary);
              border-radius:var(--radius-md);box-shadow:var(--shadow-md);
              display:flex;align-items:center;justify-content:center;
              font-weight:800;font-size:var(--step-2);color:var(--accent-primary-text);
              cursor:grab;user-select:none;touch-action:none;
            ">A</div>
            <div class="drag-card" style="
              position:absolute;left:200px;top:60px;width:100px;height:140px;
              background:var(--accent-gold-subtle);border:2px solid var(--accent-gold);
              border-radius:var(--radius-md);box-shadow:var(--shadow-md);
              display:flex;align-items:center;justify-content:center;
              font-weight:800;font-size:var(--step-2);color:var(--accent-gold-text);
              cursor:grab;user-select:none;touch-action:none;
            ">B</div>
            <div class="drag-card" style="
              position:absolute;left:340px;top:30px;width:100px;height:140px;
              background:var(--accent-cyan-subtle);border:2px solid var(--accent-cyan);
              border-radius:var(--radius-md);box-shadow:var(--shadow-md);
              display:flex;align-items:center;justify-content:center;
              font-weight:800;font-size:var(--step-2);color:var(--accent-cyan-text);
              cursor:grab;user-select:none;touch-action:none;
            ">C</div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">draggable-cards</span>
              <span class="demo-card-tags"><span class="tag">Gesture</span><span class="tag">Inertia</span></span>
            </div>
            <p class="demo-card-desc">Drag cards with momentum. Release to see inertia carry the card forward, with spring-damped settling.</p>
            <p class="demo-card-hint">Drag the cards around</p>
          </div>
        </div>

        <!-- Swipe Dismiss -->
        <div class="demo-card demo-card-wide">
          <div class="demo-card-stage" style="min-height:auto;padding:var(--space-4)">
            <div style="width:100%;max-width:360px">
              <div id="swipe-dismiss-stack" style="display:flex;flex-direction:column;gap:var(--space-2)">
                <div class="swipe-card" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--bg-elevated);border:2px solid var(--border-default);border-radius:var(--radius-sm);box-shadow:var(--shadow-sm);border-left:4px solid var(--accent-primary);cursor:grab;touch-action:none;user-select:none;font-size:var(--ui-text-sm);font-weight:600">New message from Alex</div>
                <div class="swipe-card" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--bg-elevated);border:2px solid var(--border-default);border-radius:var(--radius-sm);box-shadow:var(--shadow-sm);border-left:4px solid var(--accent-green);cursor:grab;touch-action:none;user-select:none;font-size:var(--ui-text-sm);font-weight:600">Task complete: Deploy v2</div>
                <div class="swipe-card" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--bg-elevated);border:2px solid var(--border-default);border-radius:var(--radius-sm);box-shadow:var(--shadow-sm);border-left:4px solid var(--accent-gold);cursor:grab;touch-action:none;user-select:none;font-size:var(--ui-text-sm);font-weight:600">Warning: Storage 90% full</div>
                <div class="swipe-card" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--bg-elevated);border:2px solid var(--border-default);border-radius:var(--radius-sm);box-shadow:var(--shadow-sm);border-left:4px solid var(--accent-danger);cursor:grab;touch-action:none;user-select:none;font-size:var(--ui-text-sm);font-weight:600">Error alert: Build failed</div>
                <div class="swipe-card" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--bg-elevated);border:2px solid var(--border-default);border-radius:var(--radius-sm);box-shadow:var(--shadow-sm);border-left:4px solid var(--accent-purple);cursor:grab;touch-action:none;user-select:none;font-size:var(--ui-text-sm);font-weight:600">Update ready: v3.0</div>
              </div>
            </div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">swipe-dismiss</span>
              <button class="demo-btn" id="swipe-reset-btn">Reset</button>
            </div>
            <p class="demo-card-desc">Swipe notification cards horizontally to dismiss. Past the threshold, the card flings off and remaining cards FLIP upward.</p>
            <p class="demo-card-hint">Drag a card left or right to dismiss</p>
          </div>
        </div>

        <!-- Elastic Scroll -->
        <div class="demo-card demo-card-wide">
          <div class="demo-card-stage" style="min-height:auto;padding:var(--space-4);position:relative">
            <div id="elastic-glow-left" style="position:absolute;left:0;top:0;bottom:0;width:40px;background:linear-gradient(to right,var(--accent-primary),transparent);opacity:0;pointer-events:none;z-index:2;transition:opacity 100ms"></div>
            <div id="elastic-glow-right" style="position:absolute;right:0;top:0;bottom:0;width:40px;background:linear-gradient(to left,var(--accent-primary),transparent);opacity:0;pointer-events:none;z-index:2;transition:opacity 100ms"></div>
            <div id="elastic-inner" style="display:flex;gap:var(--space-3);overflow-x:hidden;cursor:grab;touch-action:none;padding:var(--space-2) 0;will-change:transform">
              <div style="flex-shrink:0;width:120px;height:80px;background:var(--accent-primary-subtle);border:2px solid var(--accent-primary);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-primary-text)">Pink</div>
              <div style="flex-shrink:0;width:120px;height:80px;background:var(--accent-gold-subtle);border:2px solid var(--accent-gold);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-gold-text)">Gold</div>
              <div style="flex-shrink:0;width:120px;height:80px;background:var(--accent-cyan-subtle);border:2px solid var(--accent-cyan);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-cyan-text)">Cyan</div>
              <div style="flex-shrink:0;width:120px;height:80px;background:var(--accent-green-subtle);border:2px solid var(--accent-green);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-green-text)">Green</div>
              <div style="flex-shrink:0;width:120px;height:80px;background:var(--accent-purple-subtle);border:2px solid var(--accent-purple);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-purple-text)">Purple</div>
              <div style="flex-shrink:0;width:120px;height:80px;background:var(--accent-danger-subtle);border:2px solid var(--accent-danger);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-danger-text)">Red</div>
              <div style="flex-shrink:0;width:120px;height:80px;background:var(--accent-primary-subtle);border:2px solid var(--accent-primary);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-primary-text)">Pink 2</div>
              <div style="flex-shrink:0;width:120px;height:80px;background:var(--accent-gold-subtle);border:2px solid var(--accent-gold);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:var(--ui-text-xs);color:var(--accent-gold-text)">Gold 2</div>
            </div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">elastic-scroll</span>
              <span class="demo-card-tags"><span class="tag">Gesture</span><span class="tag">Spring</span></span>
            </div>
            <p class="demo-card-desc">Horizontally scrollable strip with elastic overscroll. Drag past the edge for a rubber-band effect with spring snap-back and edge glow.</p>
            <p class="demo-card-hint">Drag horizontally, pull past the edge</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ================================================================
         5. CURSOR & INTERACTIVE
         ================================================================ -->
    <section id="cursor" class="anim-section">
      <div class="section-header">
        <div class="section-overline"><span class="status-dot" style="background:var(--accent-gold)"></span> Category 05</div>
        <h2 class="section-title">Cursor &amp; Interactive</h2>
        <p class="section-desc">Magnetic buttons, spotlight effects, and spring-physics cursor trails that respond to your every move.</p>
      </div>

      <div class="demo-grid">
        <!-- Magnetic Buttons -->
        <div class="demo-card">
          <div class="demo-card-stage" id="magnetic-stage" style="display:flex;gap:var(--space-6);flex-wrap:wrap;justify-content:center">
            <button class="magnetic-btn" style="
              padding:var(--space-3) var(--space-8);font-family:var(--font-sans);
              font-size:var(--ui-text-md);font-weight:700;
              background:var(--accent-primary);color:var(--text-on-accent);
              border:2px solid var(--border-default);border-radius:var(--radius-sm);
              box-shadow:var(--shadow-md);cursor:pointer;
              transition:transform 0.2s ease-out;
            ">Hover Me</button>
            <button class="magnetic-btn" style="
              padding:var(--space-3) var(--space-8);font-family:var(--font-sans);
              font-size:var(--ui-text-md);font-weight:700;
              background:var(--accent-gold);color:var(--text-on-gold);
              border:2px solid var(--border-default);border-radius:var(--radius-sm);
              box-shadow:var(--shadow-md);cursor:pointer;
              transition:transform 0.2s ease-out;
            ">Attract</button>
            <button class="magnetic-btn" style="
              padding:var(--space-3) var(--space-8);font-family:var(--font-sans);
              font-size:var(--ui-text-md);font-weight:700;
              background:var(--accent-cyan);color:var(--text-on-accent);
              border:2px solid var(--border-default);border-radius:var(--radius-sm);
              box-shadow:var(--shadow-md);cursor:pointer;
              transition:transform 0.2s ease-out;
            ">Magnetic</button>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">magnetic-buttons</span>
              <span class="demo-card-tags"><span class="tag">Cursor</span></span>
            </div>
            <p class="demo-card-desc">Buttons that are attracted to your cursor when you hover nearby. The pull increases as you get closer.</p>
            <p class="demo-card-hint">Move cursor near the buttons</p>
          </div>
        </div>

        <!-- Spotlight Card -->
        <div class="demo-card">
          <div class="demo-card-stage" style="display:flex;gap:var(--space-4);flex-wrap:wrap;justify-content:center;padding:var(--space-6)">
            <div class="spotlight-wrap" data-accent-r="200" data-accent-g="80" data-accent-b="180" style="
              width:160px;height:120px;position:relative;
              background:var(--accent-primary-subtle);border:2px solid var(--accent-primary);
              border-radius:var(--radius-md);box-shadow:var(--shadow-md);
              display:flex;align-items:center;justify-content:center;
              font-weight:800;color:var(--accent-primary-text);overflow:hidden;cursor:default;
            "><div class="spotlight-overlay" style="position:absolute;inset:0;pointer-events:none;border-radius:inherit"></div>Hover</div>
            <div class="spotlight-wrap" data-accent-r="100" data-accent-g="160" data-accent-b="220" style="
              width:160px;height:120px;position:relative;
              background:var(--accent-cyan-subtle);border:2px solid var(--accent-cyan);
              border-radius:var(--radius-md);box-shadow:var(--shadow-md);
              display:flex;align-items:center;justify-content:center;
              font-weight:800;color:var(--accent-cyan-text);overflow:hidden;cursor:default;
            "><div class="spotlight-overlay" style="position:absolute;inset:0;pointer-events:none;border-radius:inherit"></div>Glow</div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">spotlight-card</span>
              <span class="demo-card-tags"><span class="tag">Cursor</span><span class="tag">DOM</span></span>
            </div>
            <p class="demo-card-desc">Cursor creates a radial spotlight in the card's accent color. The solid shadow shifts direction opposite the cursor — light source follows your mouse.</p>
            <p class="demo-card-hint">Move cursor over the cards</p>
          </div>
        </div>

        <!-- Spring Cursor Trail -->
        <div class="demo-card">
          <div class="demo-card-stage" style="min-height:240px">
            <canvas id="spring-trail-canvas" aria-label="Spring cursor trail: circles trailing the cursor connected by springs"></canvas>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">spring-cursor-trail</span>
              <span class="demo-card-tags"><span class="tag">Spring</span><span class="tag">Canvas</span></span>
            </div>
            <p class="demo-card-desc">12 shrinking circles trail the cursor, each springing toward its predecessor with decreasing stiffness. Colors cycle through the full token palette.</p>
            <p class="demo-card-hint">Move mouse over the canvas</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ================================================================
         6. GENERATIVE ART
         ================================================================ -->
    <section id="generative" class="anim-section">
      <div class="section-header">
        <div class="section-overline"><span class="status-dot" style="background:var(--accent-purple)"></span> Category 06</div>
        <h2 class="section-title">Generative Art</h2>
        <p class="section-desc">Algorithmic visuals driven by noise, flow fields, and spring-physics wave propagation. Unique every time, always on-brand.</p>
      </div>

      <div class="demo-grid">
        <!-- Flow Field -->
        <div class="demo-card">
          <div class="demo-card-stage" style="min-height:280px">
            <canvas id="flowfield-canvas" aria-label="Flow field: noise-based particle flow creating organic patterns"></canvas>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">flow-field</span>
              <span class="demo-card-tags"><span class="tag">Generative</span><span class="tag">Noise</span></span>
            </div>
            <p class="demo-card-desc">Particles follow a Perlin noise flow field, creating organic, wind-like patterns colored by the token palette.</p>
            <p class="demo-card-hint">Watch the flow emerge</p>
          </div>
        </div>

        <!-- Aurora Gradient (relocated from Splashy) -->
        <div class="demo-card">
          <div class="demo-card-stage" style="min-height:240px">
            <canvas id="aurora-canvas" aria-label="Aurora gradient: animated mesh gradients creating nebula-like effects"></canvas>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">aurora-gradient</span>
              <span class="demo-card-tags"><span class="tag">Generative</span><span class="tag">Gradient</span></span>
            </div>
            <p class="demo-card-desc">Animated mesh gradients using token colors to create shifting aurora/nebula effects. Soft, dreamy, organic.</p>
            <p class="demo-card-hint">Watch the colors shift</p>
          </div>
        </div>

        <!-- Token Wave -->
        <div class="demo-card">
          <div class="demo-card-stage" style="min-height:280px">
            <canvas id="token-wave-canvas" aria-label="Token wave: grid of dots displaced by radial spring-physics waves"></canvas>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">token-wave</span>
              <span class="demo-card-tags"><span class="tag">Generative</span><span class="tag">Spring</span></span>
            </div>
            <p class="demo-card-desc">A grid of ~200 dots in token palette colors. Click to send a radial wave that displaces dots with spring settling. Auto-waves every 3 seconds.</p>
            <p class="demo-card-hint">Click anywhere for a wave</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ================================================================
         7. COMPONENT SHOWCASE
         ================================================================ -->
    <section id="components" class="anim-section">
      <div class="section-header">
        <div class="section-overline"><span class="status-dot" style="background:var(--accent-cyan)"></span> Category 07</div>
        <h2 class="section-title">Component Showcase</h2>
        <p class="section-desc">Real design system components brought to life with spring physics. Toast notifications, badge counters, and more.</p>
      </div>

      <div class="demo-grid">
        <!-- Toast Stack -->
        <div class="demo-card">
          <div class="demo-card-stage" style="min-height:280px;padding:var(--space-4);align-items:flex-start;justify-content:flex-end;flex-direction:column">
            <div id="toast-container" style="width:100%;display:flex;flex-direction:column"></div>
            <button class="demo-btn" id="toast-send-btn" style="align-self:center;margin-top:var(--space-3)">Send Toast</button>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">toast-stack</span>
              <span class="demo-card-tags"><span class="tag">Component</span><span class="tag">FLIP</span></span>
            </div>
            <p class="demo-card-desc">Toast notifications that spring in from the right and auto-dismiss after 3 seconds. Remaining toasts FLIP upward when one is removed.</p>
            <p class="demo-card-hint">Click Send Toast to spawn notifications</p>
          </div>
        </div>

        <!-- Badge Counter -->
        <div class="demo-card">
          <div class="demo-card-stage" style="padding:var(--space-8)">
            <div id="badge-counter-wrap" style="display:flex;gap:var(--space-8);align-items:center">
              <button class="badge-icon-btn" data-badge-id="bell" style="position:relative;width:52px;height:52px;border-radius:var(--radius-sm);border:2px solid var(--border-default);background:var(--accent-primary-subtle);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:var(--shadow-sm)">
                &#128276;
                <span class="badge-count" style="position:absolute;top:-6px;right:-6px;min-width:20px;height:20px;border-radius:var(--radius-full);background:var(--accent-primary);color:var(--text-on-accent);font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg-surface);transform:scale(0)">0</span>
              </button>
              <button class="badge-icon-btn" data-badge-id="msg" style="position:relative;width:52px;height:52px;border-radius:var(--radius-sm);border:2px solid var(--border-default);background:var(--accent-cyan-subtle);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:var(--shadow-sm)">
                &#128172;
                <span class="badge-count" style="position:absolute;top:-6px;right:-6px;min-width:20px;height:20px;border-radius:var(--radius-full);background:var(--accent-cyan);color:var(--text-on-accent);font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg-surface);transform:scale(0)">0</span>
              </button>
              <button class="badge-icon-btn" data-badge-id="heart" style="position:relative;width:52px;height:52px;border-radius:var(--radius-sm);border:2px solid var(--border-default);background:var(--accent-purple-subtle);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:var(--shadow-sm)">
                &#10084;
                <span class="badge-count" style="position:absolute;top:-6px;right:-6px;min-width:20px;height:20px;border-radius:var(--radius-full);background:var(--accent-purple);color:var(--text-on-accent);font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid var(--bg-surface);transform:scale(0)">0</span>
              </button>
            </div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">badge-counter</span>
              <button class="demo-btn" id="badge-clear-btn">Clear All</button>
            </div>
            <p class="demo-card-desc">Icon buttons with spring-animated badge counters. Badges pop into existence from scale(0) when going 0 to 1, and spring-pop on each increment.</p>
            <p class="demo-card-hint">Click icons to increment, Clear to reset</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ================================================================
         8. COMBINED & ADVANCED
         ================================================================ -->
    <section id="combined" class="anim-section">
      <div class="section-header">
        <div class="section-overline"><span class="status-dot" style="background:var(--accent-green)"></span> Category 08</div>
        <h2 class="section-title">Combined &amp; Advanced</h2>
        <p class="section-desc">Multiple animation systems working in concert. The grand finale that showcases what token-driven JS animation can do.</p>
      </div>

      <div class="demo-grid">
        <!-- Spring + Confetti -->
        <div class="demo-card demo-card-wide">
          <div class="demo-card-stage" style="min-height:280px">
            <canvas id="combo-canvas" aria-label="Combined demo: spring button that fires confetti on click"></canvas>
            <div id="combo-btn" style="
              position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
              width:200px;height:64px;display:flex;align-items:center;justify-content:center;
              background:var(--accent-primary);color:var(--text-on-accent);
              border:2px solid var(--border-default);border-radius:var(--radius-sm);
              box-shadow:var(--shadow-lg);font-weight:800;font-size:var(--ui-text-lg);
              cursor:pointer;user-select:none;z-index:2;
            ">Celebrate!</div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">spring-confetti</span>
              <span class="demo-card-tags"><span class="tag">Combined</span><span class="tag">Spring</span><span class="tag">Particles</span></span>
            </div>
            <p class="demo-card-desc">A spring-animated button that fires confetti on click. Combines the spring press effect with the particle cannon for a celebration moment.</p>
            <p class="demo-card-hint">Click Celebrate! for the full effect</p>
          </div>
        </div>

        <!-- Spring Drag Sort -->
        <div class="demo-card demo-card-wide">
          <div class="demo-card-stage" style="min-height:auto;padding:var(--space-4)">
            <div style="width:100%;max-width:400px">
              <div id="spring-drag-sort-list" style="display:flex;flex-direction:column;gap:var(--space-2)">
                <div class="sds-item" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--accent-primary-subtle);border:2px solid var(--accent-primary);border-radius:var(--radius-sm);font-weight:700;font-size:var(--ui-text-sm);color:var(--accent-primary-text);user-select:none">
                  <span class="sds-handle" style="cursor:grab;font-size:var(--ui-text-lg);color:var(--text-muted);touch-action:none">&#8801;</span>
                  <span>Cherry</span>
                </div>
                <div class="sds-item" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--accent-gold-subtle);border:2px solid var(--accent-gold);border-radius:var(--radius-sm);font-weight:700;font-size:var(--ui-text-sm);color:var(--accent-gold-text);user-select:none">
                  <span class="sds-handle" style="cursor:grab;font-size:var(--ui-text-lg);color:var(--text-muted);touch-action:none">&#8801;</span>
                  <span>Amber</span>
                </div>
                <div class="sds-item" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--accent-cyan-subtle);border:2px solid var(--accent-cyan);border-radius:var(--radius-sm);font-weight:700;font-size:var(--ui-text-sm);color:var(--accent-cyan-text);user-select:none">
                  <span class="sds-handle" style="cursor:grab;font-size:var(--ui-text-lg);color:var(--text-muted);touch-action:none">&#8801;</span>
                  <span>Ocean</span>
                </div>
                <div class="sds-item" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--accent-green-subtle);border:2px solid var(--accent-green);border-radius:var(--radius-sm);font-weight:700;font-size:var(--ui-text-sm);color:var(--accent-green-text);user-select:none">
                  <span class="sds-handle" style="cursor:grab;font-size:var(--ui-text-lg);color:var(--text-muted);touch-action:none">&#8801;</span>
                  <span>Sage</span>
                </div>
                <div class="sds-item" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--accent-purple-subtle);border:2px solid var(--accent-purple);border-radius:var(--radius-sm);font-weight:700;font-size:var(--ui-text-sm);color:var(--accent-purple-text);user-select:none">
                  <span class="sds-handle" style="cursor:grab;font-size:var(--ui-text-lg);color:var(--text-muted);touch-action:none">&#8801;</span>
                  <span>Plum</span>
                </div>
                <div class="sds-item" style="display:flex;align-items:center;gap:var(--space-3);padding:var(--space-3) var(--space-4);background:var(--accent-danger-subtle);border:2px solid var(--accent-danger);border-radius:var(--radius-sm);font-weight:700;font-size:var(--ui-text-sm);color:var(--accent-danger-text);user-select:none">
                  <span class="sds-handle" style="cursor:grab;font-size:var(--ui-text-lg);color:var(--text-muted);touch-action:none">&#8801;</span>
                  <span>Sunset</span>
                </div>
              </div>
            </div>
          </div>
          <div class="demo-card-body">
            <div class="demo-card-top">
              <span class="demo-card-name">spring-drag-sort</span>
              <span class="demo-card-tags"><span class="tag">Combined</span><span class="tag">Spring</span><span class="tag">Gesture</span></span>
            </div>
            <p class="demo-card-desc">Drag-sortable list combining springs, gestures, and FLIP. Grab a handle to lift (scale + shadow), drag to reorder, drop to spring-animate into place.</p>
            <p class="demo-card-hint">Grab the handle and drag to reorder</p>
          </div>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="ds-footer">
      <div class="hero-dots" style="margin-bottom:var(--space-4)">
        <span class="hero-dot" style="background:var(--accent-primary);width:8px;height:8px"></span>
        <span class="hero-dot" style="background:var(--accent-gold);width:8px;height:8px"></span>
        <span class="hero-dot" style="background:var(--accent-cyan);width:8px;height:8px"></span>
      </div>
      <p><strong>Delightful</strong> — Animation System</p>
      <p style="margin-top:var(--space-2)">Part of the <a href="delightful-design-system.html">Delightful Design System</a> &middot; <a href="delightful-motion.html">Motion</a> &middot; <a href="delightful-color.html">Color</a></p>
    </footer>

  </div><!-- .page-wrap -->

  <!-- Back to top -->
  <button class="back-to-top" id="back-to-top" aria-label="Back to top">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
  </button>

  <!-- Command palette -->
  <div class="cmd-palette-overlay" id="cmd-palette-overlay">
    <div class="cmd-palette" role="dialog" aria-label="Quick navigation">
      <input class="cmd-palette-input" id="cmd-palette-input" type="text" placeholder="Jump to section..." autocomplete="off" />
      <ul class="cmd-palette-list" id="cmd-palette-list" role="listbox"></ul>
    </div>
  </div>

  <script>
    /* ==========================================================================
       DELIGHTFUL ANIMATION — Core JavaScript
       ========================================================================== */
    (function() {
      'use strict';

      const html = document.documentElement;

      // ---- OKLCH to sRGB helper ----
      function oklchToRgb(L, C, H) {
        const hRad = H * Math.PI / 180;
        const a = C * Math.cos(hRad);
        const b = C * Math.sin(hRad);
        const l_ = L + 0.3963377774 * a + 0.2158037573 * b;
        const m_ = L - 0.1055613458 * a - 0.0638541728 * b;
        const s_ = L - 0.0894841775 * a - 1.2914855480 * b;
        const l3 = l_ * l_ * l_;
        const m3 = m_ * m_ * m_;
        const s3 = s_ * s_ * s_;
        let r = 4.0767416621 * l3 - 3.3077115913 * m3 + 0.2309699292 * s3;
        let g = -1.2684380046 * l3 + 2.6097574011 * m3 - 0.3413193965 * s3;
        let bl = -0.0041960863 * l3 - 0.7034186147 * m3 + 1.7076147010 * s3;
        const toSrgb = (x) => {
          x = Math.max(0, Math.min(1, x));
          return x <= 0.0031308 ? 12.92 * x : 1.055 * Math.pow(x, 1 / 2.4) - 0.055;
        };
        return [
          Math.round(toSrgb(r) * 255),
          Math.round(toSrgb(g) * 255),
          Math.round(toSrgb(bl) * 255)
        ];
      }

      function oklchToHex(L, C, H) {
        const [r, g, b] = oklchToRgb(L, C, H);
        return '#' + [r, g, b].map(v => Math.max(0, Math.min(255, v)).toString(16).padStart(2, '0')).join('');
      }

      function oklchToRgba(L, C, H, A) {
        const [r, g, b] = oklchToRgb(L, C, H);
        return `rgba(${r},${g},${b},${A})`;
      }

      // ---- Parse token colors from computed styles ----
      function getTokenColors() {
        const style = getComputedStyle(document.documentElement);
        const parse = (val) => {
          const m = val.match(/oklch\(\s*([\d.]+)\s+([\d.]+)\s+([\d.]+)/);
          if (m) return { L: +m[1], C: +m[2], H: +m[3] };
          return null;
        };
        const get = (name) => {
          const raw = style.getPropertyValue(name).trim();
          const p = parse(raw);
          if (p) return oklchToHex(p.L, p.C, p.H);
          return '#888888';
        };
        return {
          primary: get('--accent-primary'),
          gold: get('--accent-gold'),
          cyan: get('--accent-cyan'),
          danger: get('--accent-danger'),
          green: get('--accent-green'),
          purple: get('--accent-purple'),
          text: get('--text-primary'),
          textSecondary: get('--text-secondary'),
          textMuted: get('--text-muted'),
          bgPage: get('--bg-page'),
          bgSurface: get('--bg-surface'),
          bgSubtle: get('--bg-subtle'),
          borderDefault: get('--border-default'),
        };
      }

      let colors = getTokenColors();

      // ---- Theme toggle (3-way: light -> dark -> system) ----
      const prefersDarkMq = window.matchMedia('(prefers-color-scheme: dark)');
      const savedMode = localStorage.getItem('delightful-theme-mode') || localStorage.getItem('delightful-theme') || 'system';

      function applyThemeMode(mode) {
        if (mode === 'system') {
          html.setAttribute('data-theme', prefersDarkMq.matches ? 'dark' : 'light');
          html.setAttribute('data-theme-mode', 'system');
          localStorage.setItem('delightful-theme-mode', 'system');
          localStorage.removeItem('delightful-theme');
        } else {
          html.setAttribute('data-theme', mode);
          html.removeAttribute('data-theme-mode');
          localStorage.setItem('delightful-theme-mode', mode);
          localStorage.setItem('delightful-theme', mode);
        }
        colors = getTokenColors();
      }

      applyThemeMode(savedMode === 'light' || savedMode === 'dark' ? savedMode : 'system');

      prefersDarkMq.addEventListener('change', () => {
        if (html.getAttribute('data-theme-mode') === 'system') {
          html.setAttribute('data-theme', prefersDarkMq.matches ? 'dark' : 'light');
          colors = getTokenColors();
        }
      });

      document.getElementById('theme-toggle').addEventListener('click', () => {
        const current = localStorage.getItem('delightful-theme-mode') || 'system';
        const next = current === 'light' ? 'dark' : current === 'dark' ? 'system' : 'light';
        if (document.startViewTransition) {
          document.startViewTransition(() => applyThemeMode(next));
        } else {
          applyThemeMode(next);
        }
      });

      // ---- Back to top ----
      const backToTop = document.getElementById('back-to-top');
      const heroEl = document.querySelector('.hero');
      if (backToTop && heroEl) {
        const obs = new IntersectionObserver(([entry]) => {
          backToTop.classList.toggle('visible', !entry.isIntersecting);
        }, { threshold: 0 });
        obs.observe(heroEl);
        backToTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
      }

      // ---- Command palette ----
      const cmdSections = [
        { id: 'springs', label: 'Spring Physics', color: 'var(--accent-primary)' },
        { id: 'particles', label: 'Particle Systems', color: 'var(--accent-gold)' },
        { id: 'flip', label: 'FLIP & Layout', color: 'var(--accent-green)' },
        { id: 'gestures', label: 'Gestures & Drag', color: 'var(--accent-primary)' },
        { id: 'cursor', label: 'Cursor & Interactive', color: 'var(--accent-gold)' },
        { id: 'generative', label: 'Generative Art', color: 'var(--accent-purple)' },
        { id: 'components', label: 'Component Showcase', color: 'var(--accent-cyan)' },
        { id: 'combined', label: 'Combined & Advanced', color: 'var(--accent-green)' },
      ];
      const cmdOverlay = document.getElementById('cmd-palette-overlay');
      const cmdInput = document.getElementById('cmd-palette-input');
      const cmdList = document.getElementById('cmd-palette-list');
      let cmdActiveIdx = 0;

      function renderCmdList(filter) {
        const q = (filter || '').toLowerCase();
        const filtered = cmdSections.filter(s => s.label.toLowerCase().includes(q) || s.id.includes(q));
        cmdList.innerHTML = '';
        if (!filtered.length) {
          cmdList.innerHTML = '<li class="cmd-palette-empty">No sections found</li>';
          return;
        }
        filtered.forEach((s, i) => {
          const li = document.createElement('li');
          li.className = 'cmd-palette-item' + (i === 0 ? ' active' : '');
          li.setAttribute('role', 'option');
          li.dataset.sectionId = s.id;
          li.innerHTML = '<span class="cmd-section-dot" style="background:' + s.color + '"></span>' + s.label;
          li.addEventListener('click', () => navigateToSection(s.id));
          li.addEventListener('mouseenter', () => {
            cmdList.querySelectorAll('.cmd-palette-item').forEach(el => el.classList.remove('active'));
            li.classList.add('active');
            cmdActiveIdx = i;
          });
          cmdList.appendChild(li);
        });
        cmdActiveIdx = 0;
      }

      function navigateToSection(id) {
        closeCmdPalette();
        const el = document.getElementById(id);
        if (el) el.scrollIntoView({ behavior: 'smooth' });
      }

      function openCmdPalette() {
        cmdOverlay.classList.add('active');
        cmdInput.value = '';
        renderCmdList('');
        setTimeout(() => cmdInput.focus(), 50);
      }

      function closeCmdPalette() {
        cmdOverlay.classList.remove('active');
      }

      document.getElementById('cmd-k-trigger').addEventListener('click', openCmdPalette);
      cmdOverlay.addEventListener('click', (e) => { if (e.target === cmdOverlay) closeCmdPalette(); });
      cmdInput.addEventListener('input', () => renderCmdList(cmdInput.value));
      cmdInput.addEventListener('keydown', (e) => {
        const items = cmdList.querySelectorAll('.cmd-palette-item');
        if (e.key === 'Escape') { closeCmdPalette(); return; }
        if (e.key === 'ArrowDown') { e.preventDefault(); cmdActiveIdx = Math.min(cmdActiveIdx + 1, items.length - 1); }
        if (e.key === 'ArrowUp') { e.preventDefault(); cmdActiveIdx = Math.max(cmdActiveIdx - 1, 0); }
        if (e.key === 'Enter' && items[cmdActiveIdx]) {
          navigateToSection(items[cmdActiveIdx].dataset.sectionId);
          return;
        }
        items.forEach((el, i) => el.classList.toggle('active', i === cmdActiveIdx));
      });
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          cmdOverlay.classList.contains('active') ? closeCmdPalette() : openCmdPalette();
        }
        if (e.key === 'Escape' && cmdOverlay.classList.contains('active')) closeCmdPalette();
      });

      // ---- Hero particle constellation ----
      const heroCanvas = document.getElementById('hero-canvas');
      if (heroCanvas) {
        const ctx = heroCanvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        let W, H;
        const PARTICLE_COUNT = 60;
        const CONNECTION_DIST = 120;
        const particles = [];
        let mouseX = -1000, mouseY = -1000;
        let heroAnimId = null;

        function resizeHeroCanvas() {
          const rect = heroCanvas.parentElement.getBoundingClientRect();
          W = rect.width;
          H = rect.height;
          heroCanvas.width = W * dpr;
          heroCanvas.height = H * dpr;
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        function initParticles() {
          particles.length = 0;
          const palette = [colors.primary, colors.gold, colors.cyan, colors.danger, colors.green, colors.purple];
          for (let i = 0; i < PARTICLE_COUNT; i++) {
            particles.push({
              x: Math.random() * W,
              y: Math.random() * H,
              vx: (Math.random() - 0.5) * 0.8,
              vy: (Math.random() - 0.5) * 0.8,
              r: 3 + Math.random() * 4,
              color: palette[i % palette.length],
            });
          }
        }

        function drawHero() {
          ctx.clearRect(0, 0, W, H);

          // Connections
          for (let i = 0; i < particles.length; i++) {
            for (let j = i + 1; j < particles.length; j++) {
              const dx = particles[i].x - particles[j].x;
              const dy = particles[i].y - particles[j].y;
              const dist = Math.sqrt(dx * dx + dy * dy);
              if (dist < CONNECTION_DIST) {
                const alpha = 1 - dist / CONNECTION_DIST;
                ctx.beginPath();
                ctx.moveTo(particles[i].x, particles[i].y);
                ctx.lineTo(particles[j].x, particles[j].y);
                ctx.strokeStyle = colors.borderDefault + Math.round(alpha * 40).toString(16).padStart(2, '0');
                ctx.lineWidth = 1;
                ctx.stroke();
              }
            }
          }

          // Particles
          for (const p of particles) {
            // Mouse attraction
            const dx = mouseX - p.x;
            const dy = mouseY - p.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 150 && dist > 1) {
              p.vx += dx / dist * 0.15;
              p.vy += dy / dist * 0.15;
            }

            // Damping
            p.vx *= 0.98;
            p.vy *= 0.98;

            p.x += p.vx;
            p.y += p.vy;

            // Wrap edges
            if (p.x < -10) p.x = W + 10;
            if (p.x > W + 10) p.x = -10;
            if (p.y < -10) p.y = H + 10;
            if (p.y > H + 10) p.y = -10;

            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.fill();
            ctx.strokeStyle = colors.borderDefault;
            ctx.lineWidth = 1.5;
            ctx.stroke();
          }

          heroAnimId = requestAnimationFrame(drawHero);
        }

        function handleHeroPointer(e) {
          const rect = heroCanvas.getBoundingClientRect();
          if (e.touches) {
            mouseX = e.touches[0].clientX - rect.left;
            mouseY = e.touches[0].clientY - rect.top;
          } else {
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
          }
        }

        heroCanvas.addEventListener('mousemove', handleHeroPointer);
        heroCanvas.addEventListener('touchmove', handleHeroPointer, { passive: true });
        heroCanvas.addEventListener('mouseleave', () => { mouseX = -1000; mouseY = -1000; });

        // Click creates gravity well burst
        heroCanvas.addEventListener('click', (e) => {
          const rect = heroCanvas.getBoundingClientRect();
          const cx = e.clientX - rect.left;
          const cy = e.clientY - rect.top;
          for (const p of particles) {
            const dx = p.x - cx;
            const dy = p.y - cy;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < 200 && dist > 1) {
              const force = (200 - dist) / 200 * 3;
              p.vx += (dx / dist) * force;
              p.vy += (dy / dist) * force;
            }
          }
        });

        // Lazy init hero with IntersectionObserver
        const heroObs = new IntersectionObserver(([entry]) => {
          if (entry.isIntersecting) {
            if (!heroAnimId) {
              resizeHeroCanvas();
              if (!particles.length) initParticles();
              drawHero();
            }
          } else {
            if (heroAnimId) {
              cancelAnimationFrame(heroAnimId);
              heroAnimId = null;
            }
          }
        }, { threshold: 0.1 });
        heroObs.observe(heroCanvas.parentElement);

        window.addEventListener('resize', () => {
          resizeHeroCanvas();
          if (!particles.length) initParticles();
        });

        // Reduced motion: show static frame
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          resizeHeroCanvas();
          initParticles();
          drawHero();
          cancelAnimationFrame(heroAnimId);
          heroAnimId = null;
        }
      }

      // ================================================================
      //  SPRING SOLVER
      // ================================================================
      function springStep(state, config, dt) {
        // Damped harmonic oscillator: F = -kx - cv
        const { stiffness, damping, mass } = config;
        const springForce = -stiffness * (state.value - state.target);
        const dampingForce = -damping * state.velocity;
        const acceleration = (springForce + dampingForce) / mass;
        state.velocity += acceleration * dt;
        state.value += state.velocity * dt;
      }

      // ================================================================
      //  ANIMATION MANAGER — single rAF loop
      // ================================================================
      const animations = new Map();
      let globalAnimId = null;
      const reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');

      function registerAnimation(key, updateFn) {
        animations.set(key, { update: updateFn, active: false });
      }

      function activateAnimation(key) {
        const a = animations.get(key);
        if (a) a.active = true;
        if (!globalAnimId) globalLoop();
      }

      function deactivateAnimation(key) {
        const a = animations.get(key);
        if (a) a.active = false;
      }

      let lastTime = 0;
      function globalLoop(now) {
        if (!now) now = performance.now();
        const dt = Math.min((now - lastTime) / 1000, 0.05);
        lastTime = now;

        let anyActive = false;
        animations.forEach((a) => {
          if (a.active) {
            a.update(dt, now);
            anyActive = true;
          }
        });

        if (anyActive) {
          globalAnimId = requestAnimationFrame(globalLoop);
        } else {
          globalAnimId = null;
        }
      }

      // ================================================================
      //  INTERSECTION OBSERVER for lazy activation
      // ================================================================
      function observeCanvas(canvasOrParent, key, initFn) {
        let initialized = false;
        const obs = new IntersectionObserver(([entry]) => {
          if (entry.isIntersecting) {
            if (!initialized) {
              initFn();
              initialized = true;
              // For reduced motion, draw one static frame then stop
              if (reducedMotion) {
                const a = animations.get(key);
                if (a) { a.update(0.016, performance.now()); }
                return;
              }
            }
            activateAnimation(key);
          } else {
            deactivateAnimation(key);
          }
        }, { threshold: 0.05 });
        obs.observe(canvasOrParent);
      }

      // ================================================================
      //  Canvas resize helper
      // ================================================================
      function setupCanvas(canvas) {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.parentElement.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;
        canvas.width = w * dpr;
        canvas.height = h * dpr;
        canvas.style.width = w + 'px';
        canvas.style.height = h + 'px';
        const ctx = canvas.getContext('2d');
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        return { ctx, w, h, dpr };
      }

      // ================================================================
      //  1. SPRING BUTTON
      // ================================================================
      (function() {
        const stage = document.getElementById('spring-btn-stage');
        const el = document.getElementById('spring-btn-el');
        if (!stage || !el) return;

        const state = { value: 1, velocity: 0, target: 1 };
        const config = { stiffness: 300, damping: 15, mass: 1 };
        let pressing = false;

        registerAnimation('spring-btn', (dt) => {
          springStep(state, config, dt);
          el.style.transform = `scale(${state.value})`;
          if (Math.abs(state.value - state.target) < 0.001 && Math.abs(state.velocity) < 0.01) {
            state.value = state.target;
            el.style.transform = `scale(${state.target})`;
            if (!pressing) deactivateAnimation('spring-btn');
          }
        });

        stage.addEventListener('pointerdown', (e) => {
          pressing = true;
          state.target = 0.85;
          activateAnimation('spring-btn');
        });
        stage.addEventListener('pointerup', () => {
          pressing = false;
          state.target = 1;
          activateAnimation('spring-btn');
        });
        stage.addEventListener('pointerleave', () => {
          if (pressing) {
            pressing = false;
            state.target = 1;
            activateAnimation('spring-btn');
          }
        });
        // Keyboard support
        stage.addEventListener('keydown', (e) => {
          if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            pressing = true;
            state.target = 0.85;
            activateAnimation('spring-btn');
          }
        });
        stage.addEventListener('keyup', (e) => {
          if (e.key === ' ' || e.key === 'Enter') {
            pressing = false;
            state.target = 1;
            activateAnimation('spring-btn');
          }
        });
      })();

      // ================================================================
      //  1b. SPRING CHAIN
      // ================================================================
      (function() {
        const canvas = document.getElementById('spring-chain-canvas');
        if (!canvas) return;

        let ctx, w, h;
        const NODES = 8;
        const nodes = [];
        let mx = 0, my = 0;

        function init() {
          ({ ctx, w, h } = setupCanvas(canvas));
          nodes.length = 0;
          const palette = [colors.primary, colors.gold, colors.cyan, colors.danger, colors.green, colors.purple, colors.primary, colors.gold];
          for (let i = 0; i < NODES; i++) {
            nodes.push({ x: w / 2, y: h / 2, vx: 0, vy: 0, color: palette[i % palette.length] });
          }
          mx = w / 2; my = h / 2;
        }

        canvas.parentElement.addEventListener('mousemove', (e) => {
          const rect = canvas.getBoundingClientRect();
          mx = e.clientX - rect.left;
          my = e.clientY - rect.top;
        });
        canvas.parentElement.addEventListener('mouseleave', () => { mx = w / 2; my = h / 2; });

        registerAnimation('spring-chain', (dt) => {
          ctx.clearRect(0, 0, w, h);
          // Leader follows mouse
          const leader = nodes[0];
          const stiffness = 120, damping = 12;
          leader.vx += (mx - leader.x) * stiffness * dt - leader.vx * damping * dt;
          leader.vy += (my - leader.y) * stiffness * dt - leader.vy * damping * dt;
          leader.x += leader.vx * dt;
          leader.y += leader.vy * dt;

          // Followers
          for (let i = 1; i < NODES; i++) {
            const prev = nodes[i - 1];
            const node = nodes[i];
            const s = 80 - i * 5;
            const d = 10 + i;
            node.vx += (prev.x - node.x) * s * dt - node.vx * d * dt;
            node.vy += (prev.y - node.y) * s * dt - node.vy * d * dt;
            node.x += node.vx * dt;
            node.y += node.vy * dt;
          }

          // Draw connections
          ctx.beginPath();
          ctx.moveTo(nodes[0].x, nodes[0].y);
          for (let i = 1; i < NODES; i++) {
            ctx.lineTo(nodes[i].x, nodes[i].y);
          }
          ctx.strokeStyle = colors.borderDefault + '40';
          ctx.lineWidth = 2;
          ctx.stroke();

          // Draw nodes
          for (let i = NODES - 1; i >= 0; i--) {
            const r = 14 - i;
            ctx.beginPath();
            ctx.arc(nodes[i].x, nodes[i].y, r, 0, Math.PI * 2);
            ctx.fillStyle = nodes[i].color;
            ctx.fill();
            ctx.strokeStyle = colors.borderDefault;
            ctx.lineWidth = 2;
            ctx.stroke();
          }
        });

        observeCanvas(canvas.parentElement, 'spring-chain', init);
        window.addEventListener('resize', () => { if (ctx) init(); });
      })();

      // ================================================================
      //  1c. SPRING PARAMETERS PLAYGROUND
      // ================================================================
      (function() {
        const canvas = document.getElementById('spring-params-canvas');
        if (!canvas) return;

        let ctx, w, h;
        const ball = { value: 0.15, velocity: 0, target: 0.15 };
        const ballY = { value: 0.5, velocity: 0, target: 0.5 };
        const trail = [];

        const stiffnessSlider = document.getElementById('spring-stiffness');
        const dampingSlider = document.getElementById('spring-damping');
        const massSlider = document.getElementById('spring-mass');
        const stiffnessVal = document.getElementById('spring-stiffness-val');
        const dampingVal = document.getElementById('spring-damping-val');
        const massVal = document.getElementById('spring-mass-val');

        stiffnessSlider.addEventListener('input', () => { stiffnessVal.textContent = stiffnessSlider.value; });
        dampingSlider.addEventListener('input', () => { dampingVal.textContent = dampingSlider.value; });
        massSlider.addEventListener('input', () => { massVal.textContent = (+massSlider.value).toFixed(1); });

        function init() {
          ({ ctx, w, h } = setupCanvas(canvas));
          ball.value = 0.15; ball.target = 0.85;
          ballY.value = 0.5; ballY.target = 0.5;
          trail.length = 0;
        }

        canvas.addEventListener('click', (e) => {
          const rect = canvas.getBoundingClientRect();
          ball.target = (e.clientX - rect.left) / rect.width;
          ballY.target = (e.clientY - rect.top) / rect.height;
          ball.velocity = 0;
          ballY.velocity = 0;
          trail.length = 0;
        });

        registerAnimation('spring-params', (dt) => {
          const config = {
            stiffness: +stiffnessSlider.value,
            damping: +dampingSlider.value,
            mass: +massSlider.value,
          };
          springStep(ball, config, dt);
          springStep(ballY, config, dt);

          // Track trail
          trail.push({ x: ball.value * w, y: ballY.value * h });
          if (trail.length > 80) trail.shift();

          ctx.clearRect(0, 0, w, h);

          // Draw target
          ctx.beginPath();
          ctx.arc(ball.target * w, ballY.target * h, 20, 0, Math.PI * 2);
          ctx.strokeStyle = colors.borderDefault + '30';
          ctx.lineWidth = 2;
          ctx.setLineDash([4, 4]);
          ctx.stroke();
          ctx.setLineDash([]);

          // Draw trail
          if (trail.length > 1) {
            ctx.beginPath();
            ctx.moveTo(trail[0].x, trail[0].y);
            for (let i = 1; i < trail.length; i++) {
              ctx.lineTo(trail[i].x, trail[i].y);
            }
            ctx.strokeStyle = colors.primary + '40';
            ctx.lineWidth = 2;
            ctx.stroke();
          }

          // Draw ball
          const bx = ball.value * w;
          const by = ballY.value * h;
          ctx.beginPath();
          ctx.arc(bx, by, 16, 0, Math.PI * 2);
          ctx.fillStyle = colors.primary;
          ctx.fill();
          ctx.strokeStyle = colors.borderDefault;
          ctx.lineWidth = 2;
          ctx.stroke();
        });

        observeCanvas(canvas.parentElement, 'spring-params', init);
        window.addEventListener('resize', () => { if (ctx) init(); });
      })();

      // ================================================================
      //  2a. CONFETTI CANNON
      // ================================================================
      (function() {
        const canvas = document.getElementById('confetti-canvas');
        const fireBtn = document.getElementById('confetti-fire');
        if (!canvas) return;

        let ctx, w, h;
        const POOL_SIZE = 200;
        const pool = [];
        let activeCount = 0;

        function init() {
          ({ ctx, w, h } = setupCanvas(canvas));
          pool.length = 0;
          activeCount = 0;
          for (let i = 0; i < POOL_SIZE; i++) {
            pool.push({ active: false, x: 0, y: 0, vx: 0, vy: 0, r: 0, color: '', life: 0, maxLife: 0, rotation: 0, rotSpeed: 0, shape: 0 });
          }
        }

        function emit(cx, cy, count) {
          const palette = [colors.primary, colors.gold, colors.cyan, colors.danger, colors.green, colors.purple];
          for (let i = 0; i < count && activeCount < POOL_SIZE; i++) {
            const p = pool.find(pp => !pp.active);
            if (!p) break;
            p.active = true;
            p.x = cx;
            p.y = cy;
            const angle = -Math.PI / 2 + (Math.random() - 0.5) * 1.2;
            const speed = 200 + Math.random() * 400;
            p.vx = Math.cos(angle) * speed;
            p.vy = Math.sin(angle) * speed;
            p.r = 3 + Math.random() * 5;
            p.color = palette[Math.floor(Math.random() * palette.length)];
            p.life = 0;
            p.maxLife = 1.5 + Math.random() * 1.5;
            p.rotation = Math.random() * Math.PI * 2;
            p.rotSpeed = (Math.random() - 0.5) * 10;
            p.shape = Math.floor(Math.random() * 3);
            activeCount++;
          }
          activateAnimation('confetti');
        }

        if (fireBtn) fireBtn.addEventListener('click', (e) => { e.stopPropagation(); emit(w / 2, h * 0.8, 50); });
        canvas.addEventListener('click', (e) => {
          const rect = canvas.getBoundingClientRect();
          emit(e.clientX - rect.left, e.clientY - rect.top, 40);
        });

        registerAnimation('confetti', (dt) => {
          ctx.clearRect(0, 0, w, h);
          activeCount = 0;
          for (const p of pool) {
            if (!p.active) continue;
            p.life += dt;
            if (p.life > p.maxLife) { p.active = false; continue; }
            activeCount++;
            p.vy += 400 * dt; // gravity
            p.vx *= 0.99;
            p.x += p.vx * dt;
            p.y += p.vy * dt;
            p.rotation += p.rotSpeed * dt;
            const alpha = 1 - p.life / p.maxLife;
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rotation);
            ctx.globalAlpha = alpha;
            ctx.fillStyle = p.color;
            if (p.shape === 0) {
              ctx.fillRect(-p.r, -p.r / 3, p.r * 2, p.r * 0.66);
            } else if (p.shape === 1) {
              ctx.beginPath(); ctx.arc(0, 0, p.r / 2, 0, Math.PI * 2); ctx.fill();
            } else {
              ctx.beginPath();
              ctx.moveTo(0, -p.r); ctx.lineTo(p.r * 0.7, p.r * 0.5); ctx.lineTo(-p.r * 0.7, p.r * 0.5);
              ctx.fill();
            }
            ctx.restore();
          }
          if (activeCount === 0) deactivateAnimation('confetti');
        });

        observeCanvas(canvas.parentElement, 'confetti', init);
        window.addEventListener('resize', () => { if (ctx) init(); });
      })();

      // ================================================================
      //  2b. FIREWORKS
      // ================================================================
      (function() {
        const canvas = document.getElementById('fireworks-canvas');
        if (!canvas) return;

        let ctx, w, h;
        const rockets = [];
        const sparks = [];

        function init() {
          ({ ctx, w, h } = setupCanvas(canvas));
          rockets.length = 0; sparks.length = 0;
        }

        canvas.addEventListener('click', (e) => {
          const rect = canvas.getBoundingClientRect();
          const tx = e.clientX - rect.left;
          const ty = e.clientY - rect.top;
          rockets.push({ x: w / 2, y: h, tx, ty, vy: -400 - Math.random() * 200, vx: (tx - w / 2) * 0.5, life: 0, color: [colors.primary, colors.gold, colors.cyan, colors.purple][Math.floor(Math.random() * 4)] });
          activateAnimation('fireworks');
        });

        registerAnimation('fireworks', (dt) => {
          ctx.fillStyle = colors.bgPage + '18';
          ctx.fillRect(0, 0, w, h);

          // Rockets
          for (let i = rockets.length - 1; i >= 0; i--) {
            const r = rockets[i];
            r.x += r.vx * dt;
            r.y += r.vy * dt;
            r.vy += 150 * dt;
            r.life += dt;

            ctx.beginPath();
            ctx.arc(r.x, r.y, 3, 0, Math.PI * 2);
            ctx.fillStyle = r.color;
            ctx.fill();

            if (r.vy > 0 || r.life > 2) {
              // Explode
              const count = 40 + Math.floor(Math.random() * 30);
              for (let j = 0; j < count; j++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 60 + Math.random() * 180;
                sparks.push({ x: r.x, y: r.y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, life: 0, maxLife: 0.8 + Math.random() * 0.8, color: r.color, r: 2 + Math.random() * 2 });
              }
              rockets.splice(i, 1);
            }
          }

          // Sparks
          for (let i = sparks.length - 1; i >= 0; i--) {
            const s = sparks[i];
            s.life += dt;
            if (s.life > s.maxLife) { sparks.splice(i, 1); continue; }
            s.vy += 120 * dt;
            s.vx *= 0.98;
            s.x += s.vx * dt;
            s.y += s.vy * dt;
            const alpha = 1 - s.life / s.maxLife;
            ctx.beginPath();
            ctx.arc(s.x, s.y, s.r * alpha, 0, Math.PI * 2);
            ctx.fillStyle = s.color;
            ctx.globalAlpha = alpha;
            ctx.fill();
            ctx.globalAlpha = 1;
          }

          if (rockets.length === 0 && sparks.length === 0) deactivateAnimation('fireworks');
        });

        observeCanvas(canvas.parentElement, 'fireworks', init);
        window.addEventListener('resize', () => { if (ctx) init(); });
      })();


      // ================================================================
      //  4. FLIP CARD SHUFFLE
      // ================================================================
      (function() {
        const grid = document.getElementById('flip-grid');
        const btn = document.getElementById('flip-shuffle-btn');
        if (!grid || !btn) return;

        btn.addEventListener('click', () => {
          const cards = [...grid.children];
          // FIRST: record positions
          const firstRects = cards.map(c => c.getBoundingClientRect());

          // Shuffle DOM
          for (let i = cards.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            grid.appendChild(cards[j]);
          }

          // LAST: get new positions
          const shuffled = [...grid.children];
          shuffled.forEach((card, i) => {
            const oldIdx = cards.indexOf(card);
            const first = firstRects[oldIdx];
            const last = card.getBoundingClientRect();

            // INVERT
            const dx = first.left - last.left;
            const dy = first.top - last.top;
            card.style.transform = `translate(${dx}px, ${dy}px)`;
            card.style.transition = 'none';

            // PLAY
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                card.style.transition = 'transform 400ms cubic-bezier(0.22, 1, 0.36, 1)';
                card.style.transform = '';
                card.addEventListener('transitionend', () => {
                  card.style.transition = '';
                }, { once: true });
              });
            });
          });
        });
      })();

      // ================================================================
      //  5. DRAGGABLE CARDS
      // ================================================================
      (function() {
        const stage = document.getElementById('drag-stage');
        if (!stage) return;

        const cards = stage.querySelectorAll('.drag-card');
        cards.forEach(card => {
          let dragging = false;
          let startX, startY, cardX, cardY;
          let velX = 0, velY = 0, lastX = 0, lastY = 0, lastTime = 0;
          let inertiaId = null;

          card.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            dragging = true;
            card.setPointerCapture(e.pointerId);
            card.style.cursor = 'grabbing';
            card.style.zIndex = '10';
            const rect = card.getBoundingClientRect();
            const parentRect = stage.getBoundingClientRect();
            cardX = rect.left - parentRect.left;
            cardY = rect.top - parentRect.top;
            startX = e.clientX - cardX;
            startY = e.clientY - cardY;
            lastX = e.clientX; lastY = e.clientY;
            lastTime = performance.now();
            velX = 0; velY = 0;
            if (inertiaId) cancelAnimationFrame(inertiaId);
          });

          card.addEventListener('pointermove', (e) => {
            if (!dragging) return;
            const nx = e.clientX - startX;
            const ny = e.clientY - startY;
            card.style.left = nx + 'px';
            card.style.top = ny + 'px';

            const now = performance.now();
            const dt = (now - lastTime) / 1000;
            if (dt > 0) {
              velX = (e.clientX - lastX) / dt;
              velY = (e.clientY - lastY) / dt;
            }
            lastX = e.clientX; lastY = e.clientY; lastTime = now;
          });

          card.addEventListener('pointerup', () => {
            if (!dragging) return;
            dragging = false;
            card.style.cursor = 'grab';
            card.style.zIndex = '';

            // Inertia
            let ix = velX * 0.15;
            let iy = velY * 0.15;
            function inertia() {
              ix *= 0.92;
              iy *= 0.92;
              const cl = parseFloat(card.style.left) || 0;
              const ct = parseFloat(card.style.top) || 0;
              card.style.left = (cl + ix) + 'px';
              card.style.top = (ct + iy) + 'px';
              if (Math.abs(ix) > 0.5 || Math.abs(iy) > 0.5) {
                inertiaId = requestAnimationFrame(inertia);
              }
            }
            if (Math.abs(ix) > 1 || Math.abs(iy) > 1) inertia();
          });
        });
      })();

      // ================================================================
      //  6a. FLOW FIELD
      // ================================================================
      (function() {
        const canvas = document.getElementById('flowfield-canvas');
        if (!canvas) return;

        let ctx, w, h;
        const particles = [];
        const COUNT = 300;
        let time = 0;

        // Simple Perlin-like noise using sin
        function noise(x, y, t) {
          return Math.sin(x * 0.02 + t * 0.3) * Math.cos(y * 0.02 - t * 0.2) +
                 Math.sin(x * 0.01 - y * 0.01 + t * 0.1) * 0.5;
        }

        function init() {
          ({ ctx, w, h } = setupCanvas(canvas));
          particles.length = 0;
          const palette = [colors.primary, colors.gold, colors.cyan, colors.green, colors.purple];
          for (let i = 0; i < COUNT; i++) {
            particles.push({
              x: Math.random() * w,
              y: Math.random() * h,
              color: palette[i % palette.length] + '40',
            });
          }
          ctx.fillStyle = colors.bgSubtle;
          ctx.fillRect(0, 0, w, h);
        }

        registerAnimation('flowfield', (dt) => {
          time += dt;
          ctx.fillStyle = colors.bgSubtle + '08';
          ctx.fillRect(0, 0, w, h);

          for (const p of particles) {
            const angle = noise(p.x, p.y, time) * Math.PI * 2;
            p.x += Math.cos(angle) * 1.5;
            p.y += Math.sin(angle) * 1.5;

            if (p.x < 0 || p.x > w || p.y < 0 || p.y > h) {
              p.x = Math.random() * w;
              p.y = Math.random() * h;
            }

            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 2, 2);
          }
        });

        observeCanvas(canvas.parentElement, 'flowfield', init);
        window.addEventListener('resize', () => { if (ctx) init(); });
      })();


      // ================================================================
      //  7a. MAGNETIC BUTTONS
      // ================================================================
      (function() {
        const stage = document.getElementById('magnetic-stage');
        if (!stage) return;
        const buttons = stage.querySelectorAll('.magnetic-btn');

        stage.addEventListener('mousemove', (e) => {
          buttons.forEach(btn => {
            const rect = btn.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const dx = e.clientX - cx;
            const dy = e.clientY - cy;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const threshold = 100;
            if (dist < threshold) {
              const pull = (threshold - dist) / threshold;
              btn.style.transform = `translate(${dx * pull * 0.4}px, ${dy * pull * 0.4}px)`;
            } else {
              btn.style.transform = '';
            }
          });
        });

        stage.addEventListener('mouseleave', () => {
          buttons.forEach(btn => { btn.style.transform = ''; });
        });
      })();





      // ================================================================
      //  9c. AURORA GRADIENT
      // ================================================================
      (function() {
        const canvas = document.getElementById('aurora-canvas');
        if (!canvas) return;

        let ctx, w, h;
        let time = 0;

        function init() {
          ({ ctx, w, h } = setupCanvas(canvas));
        }

        registerAnimation('aurora', (dt) => {
          time += dt * 0.5;
          ctx.clearRect(0, 0, w, h);

          const palette = [
            { color: colors.primary, x: w * (0.3 + Math.sin(time * 0.7) * 0.2), y: h * (0.3 + Math.cos(time * 0.5) * 0.2) },
            { color: colors.gold, x: w * (0.7 + Math.cos(time * 0.6) * 0.2), y: h * (0.4 + Math.sin(time * 0.4) * 0.2) },
            { color: colors.cyan, x: w * (0.5 + Math.sin(time * 0.8) * 0.3), y: h * (0.7 + Math.cos(time * 0.3) * 0.2) },
            { color: colors.purple, x: w * (0.2 + Math.cos(time * 0.5) * 0.15), y: h * (0.6 + Math.sin(time * 0.6) * 0.15) },
          ];

          for (const blob of palette) {
            const grad = ctx.createRadialGradient(blob.x, blob.y, 0, blob.x, blob.y, w * 0.4);
            grad.addColorStop(0, blob.color + '60');
            grad.addColorStop(1, blob.color + '00');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);
          }
        });

        observeCanvas(canvas.parentElement, 'aurora', init);
        window.addEventListener('resize', () => { if (ctx) init(); });
      })();

      // ================================================================
      //  1d. SPRING TOGGLE
      // ================================================================
      (function() {
        const TRAVEL = 26;
        const configs = [
          { id: 'spring-toggle-0', onColor: 'var(--accent-primary)',  off: false },
          { id: 'spring-toggle-1', onColor: 'var(--accent-green)',    off: true  },
          { id: 'spring-toggle-2', onColor: 'var(--accent-cyan)',     off: false },
          { id: 'spring-toggle-3', onColor: 'var(--accent-purple)',   off: true  },
        ];
        const OFF_BG = 'var(--primitive-neutral-300)';
        const springConfig = { stiffness: 380, damping: 18, mass: 1 };
        const toggles = configs.map((cfg, i) => {
          const el = document.getElementById(cfg.id);
          if (!el) return null;
          const knob = el.querySelector('span');
          const on = cfg.off;
          const state = { value: on ? TRAVEL : 0, velocity: 0, target: on ? TRAVEL : 0 };
          const key = 'spring-toggle-' + i;
          registerAnimation(key, (dt) => {
            if (reducedMotion) { state.value = state.target; state.velocity = 0; }
            else { springStep(state, springConfig, dt); }
            knob.style.transform = `translateX(${state.value}px)`;
            const settled = Math.abs(state.value - state.target) < 0.3 && Math.abs(state.velocity) < 0.5;
            if (settled) { state.value = state.target; state.velocity = 0; deactivateAnimation(key); }
          });
          return { el, knob, key, state, isOn: on };
        }).filter(Boolean);
        toggles.forEach(t => {
          t.knob.style.transform = `translateX(${t.state.value}px)`;
          t.el.addEventListener('click', () => {
            t.isOn = !t.isOn;
            t.state.target = t.isOn ? TRAVEL : 0;
            t.el.setAttribute('aria-checked', String(t.isOn));
            t.el.style.background = t.isOn ? configs[toggles.indexOf(t)].onColor : OFF_BG;
            const dir = t.isOn ? 1 : -1;
            t.state.velocity += dir * 80;
            activateAnimation(t.key);
          });
        });
      })();

      // ================================================================
      //  1e. SPRING ACCORDION
      // ================================================================
      (function() {
        const accordion = document.getElementById('spring-accordion');
        if (!accordion) return;
        const panels = Array.from(accordion.querySelectorAll('.sacc-panel'));
        const SPRING_OPEN = { stiffness: 260, damping: 20, mass: 1 };
        const SPRING_CLOSE = { stiffness: 320, damping: 28, mass: 1 };
        const states = panels.map((panel, i) => {
          const header = panel.querySelector('.sacc-header');
          const body = panel.querySelector('.sacc-body');
          const inner = panel.querySelector('.sacc-inner');
          const chevron = panel.querySelector('.sacc-chevron');
          return { panel, header, body, inner, chevron, isOpen: false, naturalH: 0,
            spring: { value: 0, velocity: 0, target: 0 }, key: 'sacc-' + i };
        });
        function measureHeights() {
          states.forEach(s => {
            s.body.style.height = 'auto';
            s.naturalH = s.inner.getBoundingClientRect().height + 4;
            s.body.style.height = s.isOpen ? s.naturalH + 'px' : '0px';
          });
        }
        requestAnimationFrame(measureHeights);
        states.forEach(s => {
          registerAnimation(s.key, (dt) => {
            if (reducedMotion) { s.spring.value = s.spring.target; s.spring.velocity = 0; }
            else { springStep(s.spring, s.isOpen ? SPRING_OPEN : SPRING_CLOSE, dt); }
            const h = Math.max(0, s.spring.value);
            s.body.style.height = h + 'px';
            const progress = s.naturalH > 0 ? Math.max(0, Math.min(1, h / s.naturalH)) : (s.isOpen ? 1 : 0);
            s.chevron.style.transform = `rotate(${progress * 180}deg)`;
            const settled = Math.abs(s.spring.value - s.spring.target) < 0.5 && Math.abs(s.spring.velocity) < 1;
            if (settled) {
              s.spring.value = s.spring.target; s.spring.velocity = 0;
              s.body.style.height = s.spring.target <= 0 ? '0px' : s.naturalH + 'px';
              deactivateAnimation(s.key);
            }
          });
        });
        states.forEach((s, clickedIdx) => {
          s.header.addEventListener('click', () => {
            measureHeights();
            states.forEach((t, i) => {
              const shouldOpen = (i === clickedIdx) && !t.isOpen;
              if (shouldOpen) { t.isOpen = true; t.spring.target = t.naturalH; t.header.setAttribute('aria-expanded', 'true'); t.spring.velocity += 60; }
              else if (t.isOpen && i !== clickedIdx) { t.isOpen = false; t.spring.target = 0; t.header.setAttribute('aria-expanded', 'false'); }
              else if (i === clickedIdx && t.isOpen) { t.isOpen = false; t.spring.target = 0; t.header.setAttribute('aria-expanded', 'false'); }
              activateAnimation(t.key);
            });
          });
        });
        window.addEventListener('resize', measureHeights);
      })();

      // ================================================================
      //  2c. TOKEN BUBBLES
      // ================================================================
      (function() {
        const canvas = document.getElementById('token-bubbles-canvas');
        if (!canvas) return;
        let ctx, w, h;
        const bubbles = [];
        const microPool = [];
        const MICRO_MAX = 80;
        const FAMILIES = [
          { name: 'Pink', key: 'primary' },
          { name: 'Red', key: 'danger' },
          { name: 'Gold', key: 'gold' },
          { name: 'Cyan', key: 'cyan' },
          { name: 'Green', key: 'green' },
          { name: 'Purple', key: 'purple' },
          { name: 'Neutral', key: 'textMuted' },
        ];

        function init() {
          ({ ctx, w, h } = setupCanvas(canvas));
          bubbles.length = 0;
          const r = Math.min(w, h) * 0.085;
          const positions = [
            { x: w * 0.15, y: h * 0.30 },
            { x: w * 0.38, y: h * 0.22 },
            { x: w * 0.62, y: h * 0.28 },
            { x: w * 0.85, y: h * 0.25 },
            { x: w * 0.25, y: h * 0.68 },
            { x: w * 0.52, y: h * 0.72 },
            { x: w * 0.78, y: h * 0.65 },
          ];
          FAMILIES.forEach((fam, i) => {
            const pos = positions[i];
            bubbles.push({
              x: pos.x, y: pos.y,
              vx: (Math.random() - 0.5) * 0.5,
              vy: (Math.random() - 0.5) * 0.5,
              r, color: colors[fam.key], name: fam.name,
              scale: { value: 1, velocity: 0, target: 1 },
            });
          });
          for (let i = 0; i < MICRO_MAX; i++) {
            microPool.push({ active: false, x: 0, y: 0, vx: 0, vy: 0, life: 0, maxLife: 0, color: '', r: 0 });
          }
        }

        canvas.addEventListener('click', (e) => {
          const rect = canvas.getBoundingClientRect();
          const mx = e.clientX - rect.left;
          const my = e.clientY - rect.top;
          for (const b of bubbles) {
            const dx = mx - b.x, dy = my - b.y;
            if (Math.sqrt(dx * dx + dy * dy) < b.r * b.scale.value) {
              b.scale.target = 1.3;
              b.scale.velocity = 5;
              activateAnimation('token-bubbles');
              const count = 8 + Math.floor(Math.random() * 5);
              for (let i = 0; i < count; i++) {
                const mp = microPool.find(m => !m.active);
                if (!mp) break;
                mp.active = true;
                mp.x = b.x; mp.y = b.y;
                const angle = Math.random() * Math.PI * 2;
                const speed = 40 + Math.random() * 80;
                mp.vx = Math.cos(angle) * speed;
                mp.vy = Math.sin(angle) * speed;
                mp.r = 2 + Math.random() * 3;
                mp.color = b.color;
                mp.life = 0; mp.maxLife = 0.5 + Math.random() * 0.5;
              }
              break;
            }
          }
        });

        const springCfg = { stiffness: 200, damping: 14, mass: 1 };

        registerAnimation('token-bubbles', (dt) => {
          ctx.clearRect(0, 0, w, h);

          for (const b of bubbles) {
            b.x += b.vx; b.y += b.vy;
            if (b.x - b.r < 0) { b.x = b.r; b.vx = Math.abs(b.vx); }
            if (b.x + b.r > w) { b.x = w - b.r; b.vx = -Math.abs(b.vx); }
            if (b.y - b.r < 0) { b.y = b.r; b.vy = Math.abs(b.vy); }
            if (b.y + b.r > h) { b.y = h - b.r; b.vy = -Math.abs(b.vy); }

            if (b.scale.value !== b.scale.target || Math.abs(b.scale.velocity) > 0.01) {
              springStep(b.scale, springCfg, dt);
              if (Math.abs(b.scale.value - 1) < 0.01 && b.scale.target <= 1) {
                b.scale.value = 1; b.scale.velocity = 0; b.scale.target = 1;
              }
              if (b.scale.target > 1 && b.scale.value >= b.scale.target - 0.05) {
                b.scale.target = 1;
              }
            }

            const sr = b.r * b.scale.value;
            ctx.beginPath();
            ctx.arc(b.x, b.y, sr, 0, Math.PI * 2);
            ctx.fillStyle = b.color + '30';
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = colors.borderDefault;
            ctx.stroke();

            ctx.save();
            ctx.translate(b.x + 3, b.y + 3);
            ctx.beginPath();
            ctx.arc(0, 0, sr, 0, Math.PI * 2);
            ctx.fillStyle = colors.borderDefault + '15';
            ctx.fill();
            ctx.restore();

            ctx.fillStyle = colors.text;
            ctx.font = `600 ${Math.max(10, sr * 0.35)}px Inter, sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(b.name, b.x, b.y);
          }

          let microActive = false;
          for (const mp of microPool) {
            if (!mp.active) continue;
            mp.life += dt;
            if (mp.life > mp.maxLife) { mp.active = false; continue; }
            microActive = true;
            mp.x += mp.vx * dt;
            mp.y += mp.vy * dt;
            mp.vy += 80 * dt;
            const alpha = 1 - mp.life / mp.maxLife;
            ctx.beginPath();
            ctx.arc(mp.x, mp.y, mp.r * alpha, 0, Math.PI * 2);
            ctx.fillStyle = mp.color;
            ctx.globalAlpha = alpha;
            ctx.fill();
            ctx.globalAlpha = 1;
          }
        });

        observeCanvas(canvas.parentElement, 'token-bubbles', init);
        window.addEventListener('resize', () => { if (ctx) init(); });
      })();

      // ================================================================
      //  6c. TOKEN WAVE
      // ================================================================
      (function() {
        const canvas = document.getElementById('token-wave-canvas');
        if (!canvas) return;
        let ctx, w, h;
        const COLS = 15, ROWS = 13;
        const dots = [];
        const DOT_R = 4;
        let autoTimer = 0;
        const AUTO_INTERVAL = 3;

        function init() {
          ({ ctx, w, h } = setupCanvas(canvas));
          dots.length = 0;
          const accentKeys = ['primary', 'gold', 'cyan', 'green', 'purple', 'danger'];
          const gapX = w / (COLS + 1);
          const gapY = h / (ROWS + 1);
          for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
              const idx = r * COLS + c;
              dots.push({
                homeX: (c + 1) * gapX,
                homeY: (r + 1) * gapY,
                color: colors[accentKeys[idx % accentKeys.length]],
                spring: { value: 0, velocity: 0, target: 0 },
              });
            }
          }
        }

        function triggerWave(cx, cy) {
          const maxDist = Math.sqrt(w * w + h * h) * 0.6;
          dots.forEach(d => {
            const dx = d.homeX - cx, dy = d.homeY - cy;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const delay = dist / maxDist;
            const amp = Math.max(0, 1 - dist / maxDist) * 20;
            setTimeout(() => {
              d.spring.velocity += amp * 40;
              d.spring.target = 0;
              activateAnimation('token-wave');
            }, delay * 400);
          });
          activateAnimation('token-wave');
        }

        canvas.addEventListener('click', (e) => {
          const rect = canvas.getBoundingClientRect();
          triggerWave(e.clientX - rect.left, e.clientY - rect.top);
          autoTimer = 0;
        });

        const springCfg = { stiffness: 300, damping: 12, mass: 1 };

        registerAnimation('token-wave', (dt) => {
          ctx.clearRect(0, 0, w, h);

          autoTimer += dt;
          if (autoTimer > AUTO_INTERVAL) {
            autoTimer = 0;
            triggerWave(Math.random() * w, Math.random() * h);
          }

          let anyMoving = false;
          for (const d of dots) {
            if (Math.abs(d.spring.value) > 0.1 || Math.abs(d.spring.velocity) > 0.1) {
              springStep(d.spring, springCfg, dt);
              anyMoving = true;
            } else {
              d.spring.value = 0; d.spring.velocity = 0;
            }

            const y = d.homeY + d.spring.value;
            ctx.beginPath();
            ctx.arc(d.homeX, y, DOT_R, 0, Math.PI * 2);
            ctx.fillStyle = d.color;
            ctx.fill();
            ctx.lineWidth = 1;
            ctx.strokeStyle = colors.borderDefault + '60';
            ctx.stroke();
          }
          if (!anyMoving) { autoTimer += dt; }
        });

        observeCanvas(canvas.parentElement, 'token-wave', init);
        window.addEventListener('resize', () => { if (ctx) init(); });
      })();

      // ================================================================
      //  3b. FLIP FILTER GRID
      // ================================================================
      (function() {
        const grid = document.getElementById('filter-grid');
        const btns = document.getElementById('filter-btns');
        if (!grid || !btns) return;

        btns.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-filter]');
          if (!btn) return;
          const filter = btn.dataset.filter;
          btns.querySelectorAll('[data-filter]').forEach(b => b.classList.toggle('active', b === btn));

          const cards = [...grid.children];
          const firstRects = new Map();
          cards.forEach(c => firstRects.set(c, c.getBoundingClientRect()));

          cards.forEach(c => {
            if (filter === 'all' || c.dataset.color === filter) {
              c.style.display = '';
              c.style.transform = '';
              c.style.opacity = '';
            } else {
              c.style.transform = 'scale(0)';
              c.style.opacity = '0';
            }
          });

          requestAnimationFrame(() => {
            cards.forEach(c => {
              if (c.style.transform === 'scale(0)') {
                setTimeout(() => { c.style.display = 'none'; }, 400);
                return;
              }
              const first = firstRects.get(c);
              const last = c.getBoundingClientRect();
              const dx = first.left - last.left;
              const dy = first.top - last.top;
              if (Math.abs(dx) < 1 && Math.abs(dy) < 1) return;
              c.style.transform = `translate(${dx}px, ${dy}px)`;
              c.style.transition = 'none';
              requestAnimationFrame(() => {
                c.style.transition = 'transform 400ms cubic-bezier(0.22, 1, 0.36, 1), opacity 400ms ease';
                c.style.transform = '';
                c.addEventListener('transitionend', () => { c.style.transition = ''; }, { once: true });
              });
            });
          });
        });

        // Set initial active
        const allBtn = btns.querySelector('[data-filter="all"]');
        if (allBtn) allBtn.classList.add('active');
      })();

      // ================================================================
      //  3c. FLIP REORDER LIST
      // ================================================================
      (function() {
        const list = document.getElementById('reorder-list');
        const sortBtn = document.getElementById('reorder-sort-btn');
        if (!list) return;

        function flipSwap(item, direction) {
          const items = [...list.children];
          const idx = items.indexOf(item);
          const swapIdx = idx + direction;
          if (swapIdx < 0 || swapIdx >= items.length) return;

          const other = items[swapIdx];
          const firstA = item.getBoundingClientRect();
          const firstB = other.getBoundingClientRect();

          if (direction === -1) list.insertBefore(item, other);
          else list.insertBefore(other, item);

          [
            [item, firstA],
            [other, firstB],
          ].forEach(([el, first]) => {
            const last = el.getBoundingClientRect();
            const dx = first.left - last.left;
            const dy = first.top - last.top;
            el.style.transform = `translate(${dx}px, ${dy}px)`;
            el.style.transition = 'none';
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                el.style.transition = 'transform 380ms cubic-bezier(0.22, 1, 0.36, 1)';
                el.style.transform = '';
                el.addEventListener('transitionend', () => { el.style.transition = ''; }, { once: true });
              });
            });
          });
        }

        list.addEventListener('click', (e) => {
          const btn = e.target.closest('.reorder-up, .reorder-down');
          if (!btn) return;
          const item = btn.closest('.reorder-item');
          if (!item) return;
          flipSwap(item, btn.classList.contains('reorder-up') ? -1 : 1);
        });

        if (sortBtn) {
          sortBtn.addEventListener('click', () => {
            const items = [...list.children];
            const firstRects = items.map(el => el.getBoundingClientRect());
            items.sort((a, b) => a.textContent.localeCompare(b.textContent));
            items.forEach(el => list.appendChild(el));
            items.forEach((el, i) => {
              const last = el.getBoundingClientRect();
              const dx = firstRects[items.indexOf(el) !== -1 ? [...list.children].indexOf(el) : i];
              const first = firstRects[[...document.querySelectorAll('.reorder-item')].indexOf(el)] || firstRects[i];
              if (!first) return;
              const ddx = firstRects[i].left - last.left;
              const ddy = firstRects[i].top - last.top;
              el.style.transform = `translate(${ddx}px, ${ddy}px)`;
              el.style.transition = 'none';
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  el.style.transition = 'transform 380ms cubic-bezier(0.22, 1, 0.36, 1)';
                  el.style.transform = '';
                  el.addEventListener('transitionend', () => { el.style.transition = ''; }, { once: true });
                });
              });
            });
          });
        }
      })();

      // ================================================================
      //  4b. SWIPE DISMISS
      // ================================================================
      (function() {
        const stack = document.getElementById('swipe-dismiss-stack');
        const resetBtn = document.getElementById('swipe-reset-btn');
        if (!stack) return;
        let originalHTML = stack.innerHTML;

        function initCards() {
          const cards = stack.querySelectorAll('.swipe-card');
          cards.forEach(card => {
            let startX = 0, offsetX = 0, dragging = false;

            card.addEventListener('pointerdown', (e) => {
              dragging = true;
              startX = e.clientX;
              offsetX = 0;
              card.setPointerCapture(e.pointerId);
              card.style.transition = 'none';
            });

            card.addEventListener('pointermove', (e) => {
              if (!dragging) return;
              offsetX = e.clientX - startX;
              const rotation = (offsetX / 300) * 15;
              const opacity = Math.max(0, 1 - Math.abs(offsetX) / 300);
              card.style.transform = `translateX(${offsetX}px) rotate(${rotation}deg)`;
              card.style.opacity = opacity;
            });

            card.addEventListener('pointerup', () => {
              if (!dragging) return;
              dragging = false;
              if (Math.abs(offsetX) > 120) {
                const dir = offsetX > 0 ? 1 : -1;
                card.style.transition = 'transform 300ms ease-out, opacity 300ms ease-out';
                card.style.transform = `translateX(${dir * 600}px) rotate(${dir * 30}deg)`;
                card.style.opacity = '0';
                card.addEventListener('transitionend', () => {
                  const remaining = [...stack.querySelectorAll('.swipe-card')];
                  const rects = remaining.map(c => c.getBoundingClientRect());
                  card.remove();
                  remaining.filter(c => c !== card).forEach((c, i) => {
                    const newRect = c.getBoundingClientRect();
                    const oldRect = rects[remaining.indexOf(c)];
                    if (!oldRect) return;
                    const dy = oldRect.top - newRect.top;
                    if (Math.abs(dy) < 1) return;
                    c.style.transform = `translateY(${dy}px)`;
                    c.style.transition = 'none';
                    requestAnimationFrame(() => {
                      requestAnimationFrame(() => {
                        c.style.transition = 'transform 300ms cubic-bezier(0.22, 1, 0.36, 1)';
                        c.style.transform = '';
                      });
                    });
                  });
                }, { once: true });
              } else {
                card.style.transition = 'transform 300ms cubic-bezier(0.22, 1, 0.36, 1), opacity 300ms ease';
                card.style.transform = '';
                card.style.opacity = '';
              }
            });
          });
        }

        initCards();
        if (resetBtn) {
          resetBtn.addEventListener('click', () => {
            stack.innerHTML = originalHTML;
            initCards();
          });
        }
      })();

      // ================================================================
      //  4c. ELASTIC SCROLL
      // ================================================================
      (function() {
        const inner = document.getElementById('elastic-inner');
        const glowL = document.getElementById('elastic-glow-left');
        const glowR = document.getElementById('elastic-glow-right');
        if (!inner) return;

        let dragging = false, startX = 0, scrollStart = 0;
        let overscroll = 0;
        const springState = { value: 0, velocity: 0, target: 0 };
        const springCfg = { stiffness: 300, damping: 22, mass: 1 };
        const MAX_OVER = 120;

        inner.addEventListener('pointerdown', (e) => {
          dragging = true;
          startX = e.clientX;
          scrollStart = inner.scrollLeft;
          inner.setPointerCapture(e.pointerId);
          inner.style.cursor = 'grabbing';
          overscroll = 0;
          springState.value = 0; springState.velocity = 0; springState.target = 0;
        });

        inner.addEventListener('pointermove', (e) => {
          if (!dragging) return;
          const dx = e.clientX - startX;
          const maxScroll = inner.scrollWidth - inner.clientWidth;
          const newScroll = scrollStart - dx;

          if (newScroll < 0) {
            inner.scrollLeft = 0;
            overscroll = -newScroll;
            const clamped = overscroll / (1 + overscroll / MAX_OVER);
            inner.style.transform = `translateX(${clamped}px)`;
            if (glowL) glowL.style.opacity = Math.min(1, clamped / 60);
          } else if (newScroll > maxScroll) {
            inner.scrollLeft = maxScroll;
            overscroll = -(newScroll - maxScroll);
            const clamped = -Math.abs(overscroll) / (1 + Math.abs(overscroll) / MAX_OVER);
            inner.style.transform = `translateX(${clamped}px)`;
            if (glowR) glowR.style.opacity = Math.min(1, Math.abs(clamped) / 60);
          } else {
            inner.scrollLeft = newScroll;
            overscroll = 0;
            inner.style.transform = '';
            if (glowL) glowL.style.opacity = '0';
            if (glowR) glowR.style.opacity = '0';
          }
        });

        inner.addEventListener('pointerup', () => {
          if (!dragging) return;
          dragging = false;
          inner.style.cursor = 'grab';
          if (overscroll !== 0) {
            springState.value = overscroll > 0
              ? overscroll / (1 + overscroll / MAX_OVER)
              : -Math.abs(overscroll) / (1 + Math.abs(overscroll) / MAX_OVER);
            springState.velocity = 0;
            springState.target = 0;
            activateAnimation('elastic-scroll');
          }
        });

        registerAnimation('elastic-scroll', (dt) => {
          springStep(springState, springCfg, dt);
          inner.style.transform = `translateX(${springState.value}px)`;
          const absVal = Math.abs(springState.value);
          if (glowL) glowL.style.opacity = springState.value > 0 ? Math.min(1, absVal / 60) : '0';
          if (glowR) glowR.style.opacity = springState.value < 0 ? Math.min(1, absVal / 60) : '0';
          if (absVal < 0.5 && Math.abs(springState.velocity) < 1) {
            inner.style.transform = '';
            if (glowL) glowL.style.opacity = '0';
            if (glowR) glowR.style.opacity = '0';
            deactivateAnimation('elastic-scroll');
          }
        });
      })();

      // ================================================================
      //  5b. SPOTLIGHT CARD
      // ================================================================
      (function() {
        const cards = document.querySelectorAll('.spotlight-wrap');
        cards.forEach(card => {
          const overlay = card.querySelector('.spotlight-overlay');
          if (!overlay) return;
          const r = parseInt(card.dataset.accentR || '200');
          const g = parseInt(card.dataset.accentG || '100');
          const b = parseInt(card.dataset.accentB || '200');

          card.addEventListener('mousemove', (e) => {
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const nx = (x / rect.width - 0.5);
            const ny = (y / rect.height - 0.5);
            overlay.style.background = `radial-gradient(circle 120px at ${x}px ${y}px, rgba(${r},${g},${b},0.25), transparent)`;
            const sx = -nx * 4;
            const sy = ny * 4;
            card.style.boxShadow = `${sx}px ${sy}px 0 var(--border-default)`;
          });

          card.addEventListener('mouseleave', () => {
            overlay.style.background = '';
            card.style.boxShadow = '';
          });
        });
      })();

      // ================================================================
      //  5c. SPRING CURSOR TRAIL
      // ================================================================
      (function() {
        const canvas = document.getElementById('spring-trail-canvas');
        if (!canvas) return;
        let ctx, w, h;
        const NODE_COUNT = 12;
        const nodes = [];
        let mx = -100, my = -100;

        function init() {
          ({ ctx, w, h } = setupCanvas(canvas));
          nodes.length = 0;
          for (let i = 0; i < NODE_COUNT; i++) {
            nodes.push({
              x: w / 2, y: h / 2,
              springX: { value: w / 2, velocity: 0, target: w / 2 },
              springY: { value: h / 2, velocity: 0, target: h / 2 },
            });
          }
        }

        canvas.parentElement.addEventListener('mousemove', (e) => {
          const rect = canvas.getBoundingClientRect();
          mx = e.clientX - rect.left;
          my = e.clientY - rect.top;
        });
        canvas.parentElement.addEventListener('mouseleave', () => { mx = -100; my = -100; });

        const accentKeys = ['primary', 'gold', 'cyan', 'green', 'purple', 'danger'];

        registerAnimation('spring-trail', (dt) => {
          ctx.clearRect(0, 0, w, h);
          nodes[0].springX.target = mx;
          nodes[0].springY.target = my;

          for (let i = 0; i < nodes.length; i++) {
            const n = nodes[i];
            if (i > 0) {
              n.springX.target = nodes[i - 1].x;
              n.springY.target = nodes[i - 1].y;
            }
            const stiffness = Math.max(40, 120 - i * 8);
            const damping = 12 + i;
            const cfg = { stiffness, damping, mass: 1 };
            springStep(n.springX, cfg, dt);
            springStep(n.springY, cfg, dt);
            n.x = n.springX.value;
            n.y = n.springY.value;
          }

          // Draw lines
          ctx.beginPath();
          ctx.moveTo(nodes[0].x, nodes[0].y);
          for (let i = 1; i < nodes.length; i++) {
            ctx.lineTo(nodes[i].x, nodes[i].y);
          }
          ctx.strokeStyle = colors.borderDefault + '30';
          ctx.lineWidth = 1.5;
          ctx.stroke();

          // Draw circles
          for (let i = nodes.length - 1; i >= 0; i--) {
            const n = nodes[i];
            const r = Math.max(2, 8 - i * 0.5);
            ctx.beginPath();
            ctx.arc(n.x, n.y, r, 0, Math.PI * 2);
            ctx.fillStyle = colors[accentKeys[i % accentKeys.length]] + '80';
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = colors.borderDefault;
            ctx.stroke();
          }
        });

        observeCanvas(canvas.parentElement, 'spring-trail', init);
        window.addEventListener('resize', () => { if (ctx) init(); });
      })();

      // ================================================================
      //  7a. TOAST STACK
      // ================================================================
      (function() {
        const container = document.getElementById('toast-container');
        const sendBtn = document.getElementById('toast-send-btn');
        if (!container || !sendBtn) return;

        const TYPES = [
          { label: 'Saved successfully', accent: 'green', icon: '\u2713' },
          { label: 'Check your settings', accent: 'gold', icon: '\u26A0' },
          { label: 'New update available', accent: 'cyan', icon: '\u2139' },
          { label: 'Something went wrong', accent: 'danger', icon: '\u2717' },
        ];
        let typeIdx = 0;
        const MAX_TOASTS = 4;

        function addToast() {
          const type = TYPES[typeIdx++ % TYPES.length];
          const toasts = container.querySelectorAll('.toast-item');
          if (toasts.length >= MAX_TOASTS) {
            toasts[0].remove();
          }

          const existing = [...container.querySelectorAll('.toast-item')];
          const firstRects = existing.map(el => el.getBoundingClientRect());

          const toast = document.createElement('div');
          toast.className = 'toast-item';
          toast.style.cssText = `
            display:flex;align-items:center;gap:var(--space-3);
            padding:var(--space-3) var(--space-4);
            background:var(--bg-elevated);border:2px solid var(--border-default);
            border-radius:var(--radius-sm);box-shadow:var(--shadow-sm);
            border-left:4px solid var(--accent-${type.accent});
            transform:translateX(120%);opacity:0;
            margin-bottom:var(--space-2);
            font-size:var(--ui-text-sm);font-weight:600;
          `;
          toast.innerHTML = `
            <span style="font-size:var(--ui-text-lg)">${type.icon}</span>
            <span style="flex:1">${type.label}</span>
            <button class="toast-close" style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:var(--ui-text-lg);padding:0 var(--space-1)">\u00D7</button>
          `;
          container.appendChild(toast);

          // FLIP existing
          existing.forEach((el, i) => {
            const newRect = el.getBoundingClientRect();
            const dy = firstRects[i].top - newRect.top;
            if (Math.abs(dy) > 1) {
              el.style.transform = `translateY(${dy}px)`;
              el.style.transition = 'none';
              requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                  el.style.transition = 'transform 300ms cubic-bezier(0.22, 1, 0.36, 1)';
                  el.style.transform = '';
                });
              });
            }
          });

          // Spring in
          requestAnimationFrame(() => {
            toast.style.transition = 'transform 400ms cubic-bezier(0.34, 1.56, 0.64, 1), opacity 300ms ease';
            toast.style.transform = 'translateX(0)';
            toast.style.opacity = '1';
          });

          // Close button
          toast.querySelector('.toast-close').addEventListener('click', () => removeToast(toast));

          // Auto-dismiss
          setTimeout(() => {
            if (toast.parentElement) removeToast(toast);
          }, 3000);
        }

        function removeToast(toast) {
          const remaining = [...container.querySelectorAll('.toast-item')].filter(el => el !== toast);
          const firstRects = remaining.map(el => el.getBoundingClientRect());

          toast.style.transition = 'transform 300ms ease-in, opacity 200ms ease';
          toast.style.transform = 'translateX(120%)';
          toast.style.opacity = '0';
          toast.addEventListener('transitionend', () => {
            toast.remove();
            remaining.forEach((el, i) => {
              const newRect = el.getBoundingClientRect();
              const dy = firstRects[i].top - newRect.top;
              if (Math.abs(dy) > 1) {
                el.style.transform = `translateY(${dy}px)`;
                el.style.transition = 'none';
                requestAnimationFrame(() => {
                  requestAnimationFrame(() => {
                    el.style.transition = 'transform 300ms cubic-bezier(0.22, 1, 0.36, 1)';
                    el.style.transform = '';
                  });
                });
              }
            });
          }, { once: true });
        }

        sendBtn.addEventListener('click', addToast);
      })();

      // ================================================================
      //  7b. BADGE COUNTER
      // ================================================================
      (function() {
        const wrap = document.getElementById('badge-counter-wrap');
        if (!wrap) return;
        const btns = wrap.querySelectorAll('.badge-icon-btn');
        const clearBtn = document.getElementById('badge-clear-btn');
        const springCfg = { stiffness: 400, damping: 16, mass: 1 };

        btns.forEach(btn => {
          const badge = btn.querySelector('.badge-count');
          if (!badge) return;
          let count = 0;
          const state = { value: 0, velocity: 0, target: 0 };
          const key = 'badge-' + btn.dataset.badgeId;

          registerAnimation(key, (dt) => {
            if (reducedMotion) { state.value = state.target; state.velocity = 0; }
            else { springStep(state, springCfg, dt); }
            badge.style.transform = `scale(${state.value})`;
            if (Math.abs(state.value - state.target) < 0.01 && Math.abs(state.velocity) < 0.1) {
              state.value = state.target; state.velocity = 0;
              badge.style.transform = `scale(${state.target})`;
              deactivateAnimation(key);
            }
          });

          btn.addEventListener('click', () => {
            count++;
            badge.textContent = count;
            if (count === 1) {
              state.value = 0; state.target = 1; state.velocity = 8;
            } else {
              state.target = 1.35; state.velocity = 6;
              setTimeout(() => { state.target = 1; activateAnimation(key); }, 100);
            }
            activateAnimation(key);
          });

          btn._badgeReset = () => {
            if (count === 0) return;
            count = 0;
            badge.textContent = '0';
            state.target = 0; state.velocity = -4;
            activateAnimation(key);
          };
        });

        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            btns.forEach(btn => { if (btn._badgeReset) btn._badgeReset(); });
          });
        }
      })();

      // ================================================================
      //  8b. SPRING DRAG SORT
      // ================================================================
      (function() {
        const list = document.getElementById('spring-drag-sort-list');
        if (!list) return;

        let dragItem = null;
        let dragStartY = 0;
        let dragOffsetY = 0;
        let placeholder = null;
        const itemH = 52;

        function getItems() { return [...list.querySelectorAll('.sds-item')]; }

        list.addEventListener('pointerdown', (e) => {
          const handle = e.target.closest('.sds-handle');
          if (!handle) return;
          dragItem = handle.closest('.sds-item');
          if (!dragItem) return;

          e.preventDefault();
          dragItem.setPointerCapture(e.pointerId);
          const rect = dragItem.getBoundingClientRect();
          dragStartY = e.clientY;
          dragOffsetY = 0;

          dragItem.style.zIndex = '10';
          dragItem.style.transition = 'box-shadow 200ms ease, transform 200ms ease';
          dragItem.style.boxShadow = 'var(--shadow-lg)';
          dragItem.style.transform = 'scale(1.04)';
          dragItem.style.position = 'relative';

          placeholder = document.createElement('div');
          placeholder.style.cssText = `height:${rect.height}px;margin-bottom:var(--space-2);border:2px dashed var(--border-subtle);border-radius:var(--radius-sm);transition:none;`;
          dragItem.parentElement.insertBefore(placeholder, dragItem);
        });

        list.addEventListener('pointermove', (e) => {
          if (!dragItem) return;
          dragOffsetY = e.clientY - dragStartY;
          dragItem.style.transform = `scale(1.04) translateY(${dragOffsetY}px)`;

          const items = getItems().filter(i => i !== dragItem);
          const dragRect = dragItem.getBoundingClientRect();
          const dragCenter = dragRect.top + dragRect.height / 2;

          for (const item of items) {
            const r = item.getBoundingClientRect();
            const center = r.top + r.height / 2;
            if (dragCenter < center && placeholder.nextSibling !== item) {
              list.insertBefore(placeholder, item);
              break;
            }
            if (dragCenter > center && placeholder !== item.nextSibling) {
              list.insertBefore(placeholder, item.nextSibling);
            }
          }
        });

        list.addEventListener('pointerup', () => {
          if (!dragItem) return;
          const items = getItems();
          const firstRects = items.map(el => el.getBoundingClientRect());

          list.insertBefore(dragItem, placeholder);
          placeholder.remove();
          placeholder = null;

          dragItem.style.transform = '';
          dragItem.style.boxShadow = '';
          dragItem.style.zIndex = '';
          dragItem.style.position = '';

          const updatedItems = getItems();
          updatedItems.forEach((el, i) => {
            const last = el.getBoundingClientRect();
            const origIdx = items.indexOf(el);
            if (origIdx === -1) return;
            const first = firstRects[origIdx];
            const dy = first.top - last.top;
            if (Math.abs(dy) < 1) return;
            el.style.transform = `translateY(${dy}px)`;
            el.style.transition = 'none';
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                el.style.transition = 'transform 350ms cubic-bezier(0.34, 1.56, 0.64, 1)';
                el.style.transform = '';
                el.addEventListener('transitionend', () => { el.style.transition = ''; }, { once: true });
              });
            });
          });

          dragItem = null;
        });
      })();

      // ================================================================
      //  8. COMBINED: SPRING + CONFETTI
      // ================================================================
      (function() {
        const canvas = document.getElementById('combo-canvas');
        const btn = document.getElementById('combo-btn');
        if (!canvas || !btn) return;

        let ctx, w, h;
        const comboParticles = [];
        const POOL = 150;
        const btnState = { value: 1, velocity: 0, target: 1 };
        let pressing = false;

        function init() {
          ({ ctx, w, h } = setupCanvas(canvas));
          comboParticles.length = 0;
          for (let i = 0; i < POOL; i++) {
            comboParticles.push({ active: false, x: 0, y: 0, vx: 0, vy: 0, life: 0, maxLife: 0, color: '', r: 0, rotation: 0, rotSpeed: 0, shape: 0 });
          }
        }

        function emitCombo() {
          const palette = [colors.primary, colors.gold, colors.cyan, colors.danger, colors.green, colors.purple];
          const cx = w / 2, cy = h / 2;
          let count = 0;
          for (const p of comboParticles) {
            if (p.active || count >= 60) continue;
            p.active = true;
            p.x = cx; p.y = cy;
            const angle = -Math.PI / 2 + (Math.random() - 0.5) * Math.PI;
            const speed = 200 + Math.random() * 400;
            p.vx = Math.cos(angle) * speed;
            p.vy = Math.sin(angle) * speed;
            p.r = 3 + Math.random() * 5;
            p.color = palette[Math.floor(Math.random() * palette.length)];
            p.life = 0; p.maxLife = 1 + Math.random() * 1.5;
            p.rotation = Math.random() * Math.PI * 2;
            p.rotSpeed = (Math.random() - 0.5) * 10;
            p.shape = Math.floor(Math.random() * 3);
            count++;
          }
        }

        btn.addEventListener('pointerdown', () => {
          pressing = true;
          btnState.target = 0.88;
          activateAnimation('combo');
        });
        btn.addEventListener('pointerup', () => {
          pressing = false;
          btnState.target = 1;
          emitCombo();
          activateAnimation('combo');
        });
        btn.addEventListener('pointerleave', () => {
          if (pressing) { pressing = false; btnState.target = 1; }
        });

        registerAnimation('combo', (dt) => {
          springStep(btnState, { stiffness: 300, damping: 15, mass: 1 }, dt);
          btn.style.transform = `translate(-50%, -50%) scale(${btnState.value})`;

          ctx.clearRect(0, 0, w, h);
          let active = 0;
          for (const p of comboParticles) {
            if (!p.active) continue;
            p.life += dt;
            if (p.life > p.maxLife) { p.active = false; continue; }
            active++;
            p.vy += 400 * dt;
            p.vx *= 0.99;
            p.x += p.vx * dt;
            p.y += p.vy * dt;
            p.rotation += p.rotSpeed * dt;
            const alpha = 1 - p.life / p.maxLife;
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rotation);
            ctx.globalAlpha = alpha;
            ctx.fillStyle = p.color;
            if (p.shape === 0) ctx.fillRect(-p.r, -p.r / 3, p.r * 2, p.r * 0.66);
            else if (p.shape === 1) { ctx.beginPath(); ctx.arc(0, 0, p.r / 2, 0, Math.PI * 2); ctx.fill(); }
            else { ctx.beginPath(); ctx.moveTo(0, -p.r); ctx.lineTo(p.r * 0.7, p.r * 0.5); ctx.lineTo(-p.r * 0.7, p.r * 0.5); ctx.fill(); }
            ctx.restore();
          }

          if (active === 0 && !pressing && Math.abs(btnState.value - 1) < 0.001) {
            deactivateAnimation('combo');
          }
        });

        observeCanvas(canvas.parentElement, 'combo', init);
        window.addEventListener('resize', () => { if (ctx) init(); });
      })();

    })();
  </script>
</body>
</html>
